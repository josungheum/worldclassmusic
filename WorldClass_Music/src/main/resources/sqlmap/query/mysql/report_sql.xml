<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Report">
	<resultMap type="qss.vo.ReportVo" id="ReportVo" />
	<resultMap type="qss.vo.OrderItemVo" id="OrderItemVo" />

	<select id="Report_List" parameterType="qss.vo.ReportVo" resultType="qss.vo.ReportVo">
	/*
	ID : report_sql.Report_List
	DEC : 매출내역 리스트 조회
	*/
		<include refid="Common.BeforeSQL"/>
			SELECT OM.DOMAIN_IDX		/*도메인일련번호*/
				  ,OM.BRAND_IDX		/*브랜드일련번호*/
			  	  ,OM.FRANC_IDX		/*가맹점일련번호*/
		          <!-- 시간대 별 -->
				  <if test="reportType != null and reportType != '' and reportType == 'RPT0001'">
				  ,CONCAT(CONCAT(DATE_FORMAT(OM.MOD_DATE, '%Y-%m-%d '), HOUR(OM.MOD_DATE)), '시') AS ORDER_DATE
				  </if>
				  <!-- 일자 별 -->
				  <if test="reportType != null and reportType != '' and reportType == 'RPT0002'">
				  ,STR_TO_DATE(OM.MOD_DATE, '%Y-%m-%d') AS ORDER_DATE
				  </if>
				  <!-- 요일 별 -->
				  <if test="reportType != null and reportType != '' and reportType == 'RPT0003'">
				  ,DAYOFWEEK(OM.MOD_DATE) AS DATE_TYPE
				  ,CASE DAYOFWEEK(OM.MOD_DATE)
				    WHEN '1' THEN '일요일'
				    WHEN '2' THEN '월요일'
				    WHEN '3' THEN '화요일'
				    WHEN '4' THEN '수요일'
				    WHEN '5' THEN '목요일'
				    WHEN '6' THEN '금요일'
				    WHEN '7' THEN '토요일'
				  END AS ORDER_DATE
				  </if>
				  <!-- 월별 별 -->
				  <if test="reportType != null and reportType != '' and reportType == 'RPT0004'">
				  ,CONCAT(MONTH(OM.MOD_DATE), '월') AS ORDER_DATE
				  </if>
				  <!-- 결제구분 별 -->
				  <if test="reportType != null and reportType != '' and reportType == 'RPT0005'">
				  ,STR_TO_DATE(OM.MOD_DATE, '%Y-%m-%d') AS ORDER_DATE
				  , (SELECT CODE_NAME FROM SYSTEM_CODE WHERE CODE_GROUP = 'PAY0000' AND CODE_VALUE = OM.PAY_TYPE) AS PAY_TYPE
				  </if>
		          ,count(1) ORDER_COUNT
		          ,SUM(ORDER_AMT) AS ORDER_AMT
				  ,SUM(DISC_AMT) AS DISC_AMT
				  ,SUM(PAY_AMT) AS PAY_AMT
			FROM ORDER_MASTER OM
			WHERE OM.DOMAIN_IDX = #{domainIdx}
			<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
				<if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
					AND OM.BRAND_IDX = #{brandIdx}
				</if>
				<if test="francIdx != null and francIdx != '' and francIdx != 0">
					AND OM.FRANC_IDX = #{francIdx}
				</if>
			</if>

			<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
				<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
					AND OM.BRAND_IDX = #{sessionBrandIdx}
				</if>

				/* 매장 관리자는 자신이 속한 브랜드의 자기 매장만 보이게 */
				<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0003'">
					AND OM.BRAND_IDX = #{sessionBrandIdx}
					AND OM.FRANC_IDX = #{sessionFrancIdx}
				</if>
			</if>

			AND DATE(OM.MOD_DATE) BETWEEN #{searchDay} AND #{searchEndDay}
			AND OM.PAY_PROC_CODE = 'ORD0002'

			<!-- 시간대 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0001'">
				group by DATE_FORMAT(OM.MOD_DATE, '%Y%m%d%H')
			</if>

			<!-- 일자 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0002'">
       			group by  DATE(OM.MOD_DATE)
			</if>


			<!-- 요일 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0003'">
       			group by  DAYOFWEEK(OM.MOD_DATE)
			</if>

			<!-- 월 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0004'">
       			group by  MONTH(OM.MOD_DATE)
			</if>

			<!-- 결제타입 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0005'">
       			group by  OM.PAY_TYPE
			</if>
		<include refid="Common.AfterSQL"/>
	</select>

	<select id="Report_ListCnt" parameterType="qss.vo.ReportVo" resultType="int">
		/*
		  ID  : report_sql.Report_ListCnt
		  DEC : 매출 Cnt 조회
		*/
		SELECT COUNT(A.DOMAIN_IDX)
		FROM
		(
			SELECT OM.DOMAIN_IDX		/*도메인일련번호*/
				  ,OM.BRAND_IDX		/*브랜드일련번호*/
			  	  ,OM.FRANC_IDX		/*가맹점일련번호*/
		          ,OM.ORDER_DATE
		          ,count(1) ORDER_COUNT
		          ,SUM(ORDER_AMT) AS ORDER_AMT
				  ,SUM(DISC_AMT) AS DISC_AMT
				  ,SUM(PAY_AMT) AS PAY_AMT
			FROM ORDER_MASTER OM
			WHERE OM.DOMAIN_IDX = #{domainIdx}
			<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
				<if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
					AND OM.BRAND_IDX = #{brandIdx}
				</if>
				<if test="francIdx != null and francIdx != '' and francIdx != 0">
					AND OM.FRANC_IDX = #{francIdx}
				</if>
			</if>

			<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
				<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
					AND OM.BRAND_IDX = #{sessionBrandIdx}
				</if>

				/* 매장 관리자는 자신이 속한 브랜드의 자기 매장만 보이게 */
				<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0003'">
					AND OM.BRAND_IDX = #{sessionBrandIdx}
					AND OM.FRANC_IDX = #{sessionFrancIdx}
				</if>
			</if>

			AND DATE(OM.MOD_DATE) BETWEEN #{searchDay} AND #{searchEndDay}
			AND OM.PAY_PROC_CODE = 'ORD0002'

			<!-- 시간대 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0001'">
				group by DATE_FORMAT(OM.MOD_DATE, '%Y%m%d%H')
			</if>

			<!-- 일자 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0002'">
       			group by  DATE(OM.MOD_DATE)
			</if>


			<!-- 요일 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0003'">
       			group by  DAYOFWEEK(OM.MOD_DATE)
			</if>

			<!-- 월 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0004'">
       			group by  MONTH(OM.MOD_DATE)
			</if>

			<!-- 결제타입 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0005'">
       			group by  OM.PAY_TYPE
			</if>
		) A
	</select>

	<select id="Report_Stat" parameterType="qss.vo.ReportVo" resultType="qss.vo.ReportVo">
	/*
	ID : report_sql.Report_Stat
	DEC : 매출내역 통계
	*/
			SELECT COUNT(OM.DOMAIN_IDX) ORDER_COUNT
				      ,SUM(ORDER_AMT) AS ORDER_AMT
				      ,SUM(DISC_AMT) AS DISC_AMT
				      ,SUM(PAY_AMT) AS PAY_AMT
				FROM ORDER_MASTER OM
				WHERE OM.DOMAIN_IDX = #{domainIdx}

			<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
				<if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
					AND OM.BRAND_IDX = #{brandIdx}
				</if>
				<if test="francIdx != null and francIdx != '' and francIdx != 0">
					AND OM.FRANC_IDX = #{francIdx}
				</if>
			</if>

			<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
				<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
					AND OM.BRAND_IDX = #{sessionBrandIdx}
				</if>

				/* 매장 관리자는 자신이 속한 브랜드의 자기 매장만 보이게 */
				<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0003'">
					AND OM.BRAND_IDX = #{sessionBrandIdx}
					AND OM.FRANC_IDX = #{sessionFrancIdx}
				</if>
			</if>

			AND DATE(OM.MOD_DATE) BETWEEN #{searchDay} AND #{searchEndDay}
			AND OM.PAY_PROC_CODE = 'ORD0002'
	</select>



	<select id="Report_ListExcel" parameterType="qss.vo.ReportVo" resultType="qss.vo.ReportVo">
	/*
	ID : report_sql.Report_ListExcel
	DEC : 매출내역 엑셀 리스트 조회
	*/
		<include refid="Common.BeforeSQL"/>
			SELECT OM.DOMAIN_IDX		/*도메인일련번호*/
				  ,OM.BRAND_IDX		/*브랜드일련번호*/
			  	  ,OM.FRANC_IDX		/*가맹점일련번호*/
		          <!-- 시간대 별 -->
				  <if test="reportType != null and reportType != '' and reportType == 'RPT0001'">
				  ,CONCAT(CONCAT(DATE_FORMAT(OM.MOD_DATE, '%Y-%m-%d '), HOUR(OM.MOD_DATE)), '시') AS ORDER_DATE
				  </if>
				  <!-- 일자 별 -->
				  <if test="reportType != null and reportType != '' and reportType == 'RPT0002'">
				  ,STR_TO_DATE(OM.MOD_DATE, '%Y-%m-%d') AS ORDER_DATE
				  </if>
				  <!-- 요일 별 -->
				  <if test="reportType != null and reportType != '' and reportType == 'RPT0003'">
				  ,CASE DAYOFWEEK(OM.MOD_DATE)
				    WHEN '1' THEN '일요일'
				    WHEN '2' THEN '월요일'
				    WHEN '3' THEN '화요일'
				    WHEN '4' THEN '수요일'
				    WHEN '5' THEN '목요일'
				    WHEN '6' THEN '금요일'
				    WHEN '7' THEN '토요일'
				  END AS ORDER_DATE
				  </if>
				  <!-- 월별 별 -->
				  <if test="reportType != null and reportType != '' and reportType == 'RPT0004'">
				  ,CONCAT(MONTH(OM.MOD_DATE), '월') AS ORDER_DATE
				  </if>
				  <!-- 결제구분 별 -->
				  <if test="reportType != null and reportType != '' and reportType == 'RPT0005'">
				  ,STR_TO_DATE(OM.MOD_DATE, '%Y-%m-%d') AS ORDER_DATE
				  , (SELECT CODE_NAME FROM SYSTEM_CODE WHERE CODE_GROUP = 'PAY0000' AND CODE_VALUE = OM.PAY_TYPE) AS PAY_TYPE
				  </if>
		          ,count(1) ORDER_COUNT
		          ,SUM(ORDER_AMT) AS ORDER_AMT
				  ,SUM(DISC_AMT) AS DISC_AMT
				  ,SUM(PAY_AMT) AS PAY_AMT
			FROM ORDER_MASTER OM
			WHERE OM.DOMAIN_IDX = #{domainIdx}
			<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
				<if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
					AND OM.BRAND_IDX = #{brandIdx}
				</if>
				<if test="francIdx != null and francIdx != '' and francIdx != 0">
					AND OM.FRANC_IDX = #{francIdx}
				</if>
			</if>

			<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
				<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
					AND OM.BRAND_IDX = #{sessionBrandIdx}
				</if>

				/* 매장 관리자는 자신이 속한 브랜드의 자기 매장만 보이게 */
				<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0003'">
					AND OM.BRAND_IDX = #{sessionBrandIdx}
					AND OM.FRANC_IDX = #{sessionFrancIdx}
				</if>
			</if>

			AND DATE(OM.MOD_DATE) BETWEEN #{searchDay} AND #{searchEndDay}
			AND OM.PAY_PROC_CODE = 'ORD0002'

			<!-- 시간대 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0001'">
				group by DATE_FORMAT(OM.MOD_DATE, '%Y%m%d%H')
			</if>

			<!-- 일자 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0002'">
       			group by  DATE(OM.MOD_DATE)
			</if>


			<!-- 요일 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0003'">
       			group by  DAYOFWEEK(OM.MOD_DATE)
			</if>

			<!-- 월 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0004'">
       			group by  MONTH(OM.MOD_DATE)
			</if>

			<!-- 결제타입 별 -->
			<if test="reportType != null and reportType != '' and reportType == 'RPT0005'">
       			group by  OM.PAY_TYPE
			</if>
		) AS A
		<if test="sSortName != null and sSortName != ''">
				ORDER BY ${sSortName}  ${sSortDir_0}
		</if>
		<if test="sSortName == null or sSortName == ''">
			<if test="defaultOrderName != null and defaultOrderName != ''">
				ORDER BY ${defaultOrderName}  ${defaultOrderType}
			</if>
		</if>
	</select>


	<select id="Report_ListExcel_bak" parameterType="qss.vo.ReportVo" resultType="qss.vo.ReportVo">
	/*
	ID : report_sql.Report_ListExcel
	DEC : 매출내역 엑셀 리스트 조회
	*/
		SELECT
			CASE
				WHEN #{searchType} = 'MON'
					THEN date_format(DATE(OM.ORDER_DATE), '%Y-%m')
				ELSE
					date_format(DATE(OM.ORDER_DATE), '%Y-%m-%d')
			END AS ORDER_DATE
            ,b.NAME AS BRD_NAME
            ,f.FRANC_NAME
			,SUM(PAY_AMT) AS PAY_AMT
            ,count(1) AS ORDER_COUNT
		FROM ORDER_MASTER OM
    		 INNER JOIN brand b ON  b.DOMAIN_IDX = OM.DOMAIN_IDX AND b.BRAND_IDX = OM.BRAND_IDX /*AND ifnull(b.DEL_YN, 'N') = 'N'*/
    		 INNER JOIN franchisee f ON  f.DOMAIN_IDX = OM.DOMAIN_IDX AND f.BRAND_IDX = OM.BRAND_IDX AND f.FRANC_IDX = OM.FRANC_IDX /*AND ifnull(f.DEL_YN, 'N') = 'N'*/
		WHERE OM.DOMAIN_IDX = #{domainIdx}
		AND OM.PAY_PROC_CODE = 'ORD0002'
			AND OM.BRAND_IDX = #{brandIdx}
			AND OM.FRANC_IDX IN
			<foreach collection="checkboxFrancArr" item="francIdx" open="(" close=")" separator=",">
		        #{francIdx}
		    </foreach>

			<if test="searchType != null and searchType != '' and searchType == 'DAY'">
				AND DATE(OM.ORDER_DATE) BETWEEN #{searchStartDate} AND #{searchEndDate}
			</if>

			<if test="searchType != null and searchType != '' and searchType == 'MON'">
				AND DATE(OM.ORDER_DATE) BETWEEN CONCAT(#{searchStartDate}, '-01') AND CONCAT(#{searchEndDate}, '-31')
			</if>



			GROUP BY OM.DOMAIN_IDX,OM.BRAND_IDX, OM.FRANC_IDX, OM.ORDER_DATE
			ORDER BY  OM.DOMAIN_IDX,OM.BRAND_IDX, OM.FRANC_IDX, OM.ORDER_DATE
	</select>
	
	<!-- 요일별 브랜드 조회 수 : report_sql.Report_BrandCountByDayofweek -->
	<select id="Report_BrandCountByDayofweek" parameterType="qss.vo.ReportVo" resultType="qss.vo.report.ReportCustom">
		SELECT DAYOFWEEK, ACTION_NAME, COUNT(KIOSKLOG_IDX) AS count
		FROM kiosklog_h
		WHERE ACTION_TYPE = '브랜드' AND PLAYDATE BETWEEN #{searchDay} AND #{searchEndDay}
		GROUP BY
        DAYOFWEEK, ACTION_NAME
	</select>
	
	<!-- 일별 브랜드 조회 수 : report_sql.Report_BrandCountByDay -->
	<select id="Report_BrandCountByDay" parameterType="qss.vo.ReportVo" resultType="qss.vo.report.ReportCustom">
		SELECT PLAYDATE, ACTION_NAME, COUNT(KIOSKLOG_IDX) AS count
		FROM kiosklog_h
		WHERE ACTION_TYPE = '브랜드' AND PLAYDATE BETWEEN #{searchDay} AND #{searchEndDay}
		GROUP BY
        PLAYDATE, ACTION_NAME
	</select>
	
	<!-- 시간대별 Action 수 : report_sql.Report_ActionCountByHour -->
	<select id="Report_ActionCountByHour" parameterType="qss.vo.ReportVo" resultType="qss.vo.report.ReportCustom">
		SELECT LEFT(STARTTIME, 2) AS time, COUNT(KIOSKLOG_IDX) AS count
		FROM kiosklog_h
		WHERE PLAYDATE BETWEEN #{searchDay} AND #{searchEndDay}
		GROUP BY LEFT(STARTTIME, 2)
	</select>
	
	<!-- 요일별 Action 수 : report_sql.Report_ActionCountByDayofweek -->
	<select id="Report_ActionCountByDayofweek" parameterType="qss.vo.ReportVo" resultType="qss.vo.report.ReportCustom">
		SELECT DAYOFWEEK, COUNT(KIOSKLOG_IDX) AS count
        FROM kiosklog_h
        WHERE PLAYDATE BETWEEN #{searchDay} AND #{searchEndDay}
		GROUP BY DAYOFWEEK;
	</select>
</mapper>