<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ScheduleReport">

	<resultMap type="qss.vo.ScheduleReportVo" id="ScheduleReportVo" />

	<select id="ScheduleReport_ServiceList" parameterType="qss.vo.ScheduleReportVo" resultType="hashmap">
		SELECT	BRAND_IDX as brandIdx, NAME as brandName
		FROM	brand
		WHERE	ACTIVE_YN = 'Y'
				AND DEL_YN = 'N'
		        AND DOMAIN_IDX = #{domainIdx}
	</select>
	
	<select id="ScheduleReport_SiteList" parameterType="qss.vo.ScheduleReportVo" resultType="hashmap">
		SELECT	BRAND_IDX as brandIdx,
				FRANC_IDX as francIdx,
				FRANC_NAME as francName
		FROM	franchisee
		WHERE	ACTIVE_YN = 'Y'
				AND DEL_YN = 'N'
		        AND DOMAIN_IDX = #{domainIdx}
		        <if test='brandIdx != "" and brandIdx != null and brandIdx != 0'>
		        	AND BRAND_IDX = #{brandIdx}
		        </if>
	</select>
	
	<select id="ScheduleReport_PlayerList" parameterType="qss.vo.ScheduleReportVo" resultType="hashmap">
		SELECT	BRAND_IDX as brandIdx,
				FRANC_IDX as francIdx,
				DEVICE_IDX as deviceIdx,
				DEVICE_NAME as deviceName
		FROM	kiosk
		WHERE	ACTIVE_YN = 'Y'
				AND DEL_YN = 'N'
		        AND DOMAIN_IDX = #{domainIdx}
		        <if test='brandIdx != "" and brandIdx != null and brandIdx != 0'>
		        	AND BRAND_IDX = #{brandIdx}
		        </if>
		        <if test='francIdx != "" and francIdx != null and francIdx != 0'>
		        	AND FRANC_IDX = #{francIdx}
		        </if>
	</select>
	
	<select id="ScheduleReport_List" parameterType="qss.vo.ScheduleReportVo" resultType="qss.vo.ScheduleReportVo">
		<include refid="Common.BeforeSQL"/>
		SELECT	A.BRAND_IDX,
				B.NAME AS SERVICE_NAME,
		        A.FRANC_IDX,
		        C.FRANC_NAME AS SITE_NAME,
		        A.DEVICE_IDX,
		        D.DEVICE_NAME AS PLAYER_NAME,
		        A.SP_DATE,
		        A.SP_SCHEDSTARTTIME,
		        A.SP_SCHEDENDTIME,
		        A.SP_SCHEDPLAYTIME,
		        A.SP_REALSTARTTIME,
		        A.SP_REALENDTIME,
		        A.SP_REALPLAYTIME,
		        A.SP_STATUS,
		        A.SP_DIFF
		FROM	schedule_stat_h A
				INNER JOIN brand B ON A.BRAND_IDX = B.BRAND_IDX AND B.DEL_YN = 'N'
		        INNER JOIN franchisee C ON A.FRANC_IDX = C.FRANC_IDX AND C.DEL_YN = 'N'
		        INNER JOIN kiosk D ON A.DEVICE_IDX = D.DEVICE_IDX AND D.DEL_YN = 'N'
		WHERE	A.BRAND_IDX = #{brandIdx}
				<if test='francIdx != "" and francIdx != null and francIdx != 0'>
		        	AND A.FRANC_IDX = #{francIdx}
		        </if>
				<if test='deviceIdx != "" and deviceIdx != null and deviceIdx != 0'>
		        	AND A.DEVICE_IDX = #{deviceIdx}
		        </if>
		        AND A.SP_DATE BETWEEN #{searchStart} AND #{searchEnd}
		<include refid="Common.AfterSQL"/>
	</select>
	
	<select id="ScheduleReport_ListCnt" parameterType="qss.vo.ScheduleReportVo" resultType="int">
		SELECT	COUNT(A.BRAND_IDX) AS CNT
		FROM	schedule_stat_h A
				INNER JOIN brand B ON A.BRAND_IDX = B.BRAND_IDX AND B.DEL_YN = 'N'
		        INNER JOIN franchisee C ON A.FRANC_IDX = C.FRANC_IDX AND C.DEL_YN = 'N'
		        INNER JOIN kiosk D ON A.DEVICE_IDX = D.DEVICE_IDX AND D.DEL_YN = 'N'
		WHERE	A.BRAND_IDX = #{brandIdx}
				<if test='francIdx != "" and francIdx != null and francIdx != 0'>
		        	AND A.FRANC_IDX = #{francIdx}
		        </if>
				<if test='deviceIdx != "" and deviceIdx != null and deviceIdx != 0'>
		        	AND A.DEVICE_IDX = #{deviceIdx}
		        </if>
		        AND A.SP_DATE BETWEEN #{searchStart} AND #{searchEnd}
	</select>
	
	
	
	
	
	
	<insert id="ScheduleReport_BatchReportInsert" parameterType="qss.vo.ScheduleReportVo">
		<![CDATA[
			INSERT INTO schedule_stat_h
			(SP_DATE,
			DOMAIN_IDX,
			BRAND_IDX,
			FRANC_IDX,
			DEVICE_IDX,
			SP_SCHEDSTARTTIME,
			SP_SCHEDENDTIME,
			SP_SCHEDPLAYTIME,
			SP_REALSTARTTIME,
			SP_REALENDTIME,
			SP_REALPLAYTIME,
			SP_STATUS,
			SP_DIFF,
			REG_DATE)
			SELECT	PL_PLAYDATE AS SP_DATE,
					DOMAIN_IDX,
					BRAND_IDX,
					FRANC_IDX,
					DEVICE_IDX,
					MIN(PL_STARTTIME) AS SP_SCHEDSTARTTIME,
					MAX(PL_ENDTIME) AS SP_SCHEDENDTIME,
					(MAX(PL_ENDTIME) - MIN(PL_STARTTIME)) AS SP_SCHEDPLAYTIME,
					MIN(PL_STARTTIME) AS SP_REALSTARTTIME,
					MAX(PL_ENDTIME) AS SP_REALENDTIME,
					(SUM(PL_PLAYMILLITIME) DIV 1000) AS SP_REALPLAYTIME,
					'N' AS SP_STATUS,
					((SUM(PL_PLAYMILLITIME) DIV 1000) - (MAX(PL_ENDTIME) - MIN(PL_STARTTIME))) AS SP_DIFF,
					NOW() AS REG_DATE
			FROM	playlog_h
			WHERE	PL_PLAYDATE < DATE_FORMAT(NOW(), '%Y%m%d')
					AND (PL_PLAYDATE, DOMAIN_IDX, BRAND_IDX, FRANC_IDX, DEVICE_IDX) NOT IN (SELECT	SP_DATE, DOMAIN_IDX, BRAND_IDX, FRANC_IDX, DEVICE_IDX FROM schedule_stat_h)
			GROUP BY PL_PLAYDATE, DOMAIN_IDX, BRAND_IDX, FRANC_IDX, DEVICE_IDX
		]]>
	</insert>
</mapper>