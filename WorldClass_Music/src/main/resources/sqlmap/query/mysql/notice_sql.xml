<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="NoticeManagement">

	<select id="Notice_ListNotice" parameterType="qss.vo.NoticeVo" resultType="qss.vo.NoticeVo">
		/*
		  ID  : Notice_sql.Notice_ListNotice
		  DEC : 브랜드 공지사항 목록 조회
		*/
		<include refid="Common.BeforeSQL"/>
		SELECT  TITLE
		      , date_format(START_DATE, '%Y-%c-%e') AS START_DATE
		      , date_format(END_DATE, '%Y-%c-%e') AS END_DATE
		      , REG_USER
		      , date_format(REG_DATE, '%Y-%c-%e') AS REG_DATE
		      , date_format(MOD_DATE, '%Y-%c-%e') AS MOD_DATE
		      , ACTIVE_YN
		      , NOTICE_IDX
		FROM    NOTICE
		WHERE   IFNULL(DEL_YN, 'N') = 'N'
		AND     DOMAIN_IDX = #{domainIdx}
		AND     BRAND_IDX = #{brandIdx}
		<if test="francIdx != null and francIdx != '' and francIdx != 0">
			AND FRANC_IDX = #{francIdx}
		</if>
		<if test="francIdx == null or francIdx == '' or francIdx == 0">
			AND BRAND_ONLY_YN = 'Y'
		</if>
		<if test="sSearch != null and sSearch != ''">
            AND TITLE LIKE CONCAT('%',#{sSearch},'%')
        </if>
        <if test="sSortName == null or sSortName == ''">
<!--         ORDER BY MOD_DATE -->
        </if>
        <include refid="Common.AfterSQL"/>
	</select>

	<select id="Notice_ListCountNotice" parameterType="qss.vo.NoticeVo" resultType="int">
		/*
		  ID  : Notice_sql.Notice_ListCountNotice
		  DEC : 브랜드 공지사항 카운터
		*/
		SELECT COUNT(*)
		FROM   NOTICE
		WHERE  IFNULL(DEL_YN, 'N') = 'N'
		AND    DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		<if test="francIdx != null and francIdx != '' and francIdx != 0">
			AND FRANC_IDX = #{francIdx}
		</if>
		<if test="francIdx == null or francIdx == '' or francIdx == 0">
			AND BRAND_ONLY_YN = 'Y'
		</if>
		<if test="sSearch != null and sSearch != ''">
            AND TITLE LIKE CONCAT('%',#{sSearch},'%')
        </if>
	</select>

	<select id="Notice_ViewNotice" parameterType="qss.vo.NoticeVo" resultType="qss.vo.NoticeVo">
		/*
		  ID  : Notice_sql.Notice_ViewNotice
		  DEC : 공지사항 상세 조회
		*/
		SELECT  TITLE
		      , date_format(START_DATE, '%Y-%c-%e') AS START_DATE
		      , date_format(END_DATE, '%Y-%c-%e') AS END_DATE
		      , REG_USER
		      , date_format(REG_DATE, '%Y-%c-%e') AS REG_DATE
		      , ACTIVE_YN
		      , NOTICE_IDX
		      , CONTENT
		      , POPUP_ACTIVE_YN
		      , date_format(POPUP_START_DATE, '%Y-%c-%e') AS POPUP_START_DATE
		      , date_format(POPUP_END_DATE, '%Y-%c-%e') AS POPUP_END_DATE
		      , IS_HTML_YN
		FROM    NOTICE
		WHERE   IFNULL(DEL_YN, 'N') = 'N'
		AND     DOMAIN_IDX = #{domainIdx}
		AND     NOTICE_IDX = #{noticeIdx}
		AND     BRAND_IDX = #{brandIdx}
		<if test="francIdx != null and francIdx != '' and francIdx != 0">
			AND FRANC_IDX = #{francIdx}
		</if>
		<if test="francIdx == null or francIdx == '' or francIdx == 0">
			AND BRAND_ONLY_YN = 'Y'
		</if>
	</select>

	<insert id="Notice_InsertNotice" parameterType="qss.vo.NoticeVo" >
		/*
		  ID  : notice_sql.Notice_InsertNotice
		  DEC : 공지사항 등록
		*/
		<selectKey keyProperty="returnIdx" resultType="biginteger" order="BEFORE">
			SELECT IFNULL(MAX(NOTICE_IDX) + 1, '1')
			FROM   NOTICE
			WHERE  DOMAIN_IDX = #{domainIdx}
			AND    BRAND_IDX = #{brandIdx}
		</selectKey>
		INSERT INTO NOTICE
		(
			  DOMAIN_IDX
			, BRAND_IDX
			, NOTICE_IDX
			, TITLE
			, CONTENT
			, IS_HTML_YN
			, POPUP_ACTIVE_YN
			, POPUP_START_DATE
			, POPUP_END_DATE
			, ACTIVE_YN
			, START_DATE
			, END_DATE
			, FRANC_IDX
			, BRAND_ONLY_YN
			, DEL_YN
			, REG_USER
			, REG_DATE
			, MOD_USER
			, MOD_DATE
		)
		VALUES
		(
			  #{domainIdx}
		    , #{brandIdx}
		    , #{returnIdx}
		    , #{title}
		    , #{content}
		    , #{isHtmlYn}
		    , #{popupActiveYn}
		    , #{popupStartDate}
		    , #{popupEndDate}
		    , #{activeYn}
		    , #{startDate}
		    , #{endDate}
		    , #{francIdx}
		    , #{brandOnlyYn}
		    , 'N'
		    , #{regUser}
		    , now()
		    , #{regUser}
		    , now()
		 )
	</insert>

	<update id="Notice_UpdateNotice" parameterType="qss.vo.NoticeVo">
		/*
		  ID  : notice_sql.Notice_UpdateNotice
		  DEC : 공지사항 수정
		*/
		UPDATE NOTICE
		SET
		      TITLE = #{title}
			, CONTENT = #{content}
			, IS_HTML_YN = #{isHtmlYn}
			, POPUP_ACTIVE_YN = #{popupActiveYn}
			, POPUP_START_DATE = #{popupStartDate}
			, POPUP_END_DATE = #{popupEndDate}
			, ACTIVE_YN = #{activeYn}
			, START_DATE = #{startDate}
			, END_DATE = #{endDate}
			, MOD_DATE = now()
			, MOD_USER = #{regUser}
		WHERE DOMAIN_IDX = #{domainIdx}
		AND   BRAND_IDX = #{brandIdx}
		<if test="francIdx != null and francIdx != '' and francIdx != 0">
			AND FRANC_IDX = #{francIdx}
		</if>
		<if test="francIdx == null or francIdx == '' or francIdx == 0">
			AND BRAND_ONLY_YN = 'Y'
		</if>
		AND   NOTICE_IDX = #{noticeIdx}
	</update>

	<update id="Notice_DeleteNotice" parameterType="qss.vo.NoticeVo">
		/*
		  ID  : notice_sql.Notice_DeleteNotice
		  DEC : 공지글 삭제
		*/
		UPDATE NOTICE
		set    DEL_YN = 'Y'
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		<if test="francIdx != null and francIdx != '' and francIdx != 0">
			AND FRANC_IDX = #{francIdx}
		</if>
		<if test="francIdx == null or francIdx == '' or francIdx == 0">
			AND BRAND_ONLY_YN = 'Y'
		</if>
		AND NOTICE_IDX IN
		<foreach collection="checkboxArr" item="id" open="(" close=")" separator=",">
	        #{id}
	    </foreach>

	</update>

	<update id="Notice_ActiveNotice" parameterType="qss.vo.NoticeVo">
		/*
		  ID  : notice_sql.Notice_ActiveNotice
		  DEC : 사용자 활성화 여부
		*/
		UPDATE NOTICE
		set    MOD_USER = #{regUser}
		     , MOD_DATE = now()
		     , ACTIVE_YN = #{activeYn}
		WHERE  NOTICE_IDX = #{noticeIdx}
		AND    DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		<if test="francIdx != null and francIdx != '' and francIdx != 0">
			AND FRANC_IDX = #{francIdx}
		</if>
		<if test="francIdx == null or francIdx == '' or francIdx == 0">
			AND BRAND_ONLY_YN = 'Y'
		</if>
	</update>

	<insert id="Notice_InsertScheduleVersion" parameterType="qss.vo.NoticeVo">
		/*
		  ID  : notice_sql.Notice_InsertScheduleVersion
		  DEC : 공지사항 기준 스케줄버전 추가
		*/
		INSERT INTO SCHEDULE_VERSION
		(
		  DEVICE_CODE
		 ,SCHEDULE_VERSION_IDX
		 ,SCHEDULE_TYPE
		 ,MOD_REASON
		 ,REG_USER
		 ,REG_DATE
		 ,MOD_USER
		 ,MOD_DATE
		)
		SELECT
		  A.DEVICE_CODE,
		  A.SCHEDULE_VERSION_IDX,
		  A.SCHEDULE_TYPE,
		  A.MOD_REASON,
		  A.REG_USER,
		  A.REG_DATE,
		  A.REG_USER,
		  A.MOD_DATE
		FROM
		  (
			SELECT K.DEVICE_CODE
		      ,(
		      		SELECT IFNULL(MAX(SCHEDULE_VERSION_IDX) + 1, 1)
		      		FROM   SCHEDULE_VERSION
		      		WHERE  DEVICE_CODE = K.DEVICE_CODE
<!-- 		      		AND    SCHEDULE_TYPE = #{scheduleType} -->
		      	) AS SCHEDULE_VERSION_IDX
		      ,#{scheduleType} AS SCHEDULE_TYPE
		      ,(
		      		SELECT CODE_NAME
		      		FROM   SYSTEM_CODE
		      		WHERE  CODE_GROUP = 'SCH0000' AND  CODE_VALUE = #{scheduleType}
		      		AND    IFNULL(DEL_YN, 'N') = 'N'
		      	) AS MOD_REASON
		      ,#{regUser} AS REG_USER
		      ,now() AS REG_DATE
		      ,#{regUser} AS MOD_USER
		      ,now() AS MOD_DATE
		FROM   KIOSK K
		INNER  JOIN NOTICE N
		ON     K.DOMAIN_IDX = N.DOMAIN_IDX
		AND    K.BRAND_IDX = N.BRAND_IDX
		AND    IFNULL(K.DEL_YN, 'N') = 'N'
		<if test="francIdx != null and francIdx != '' and francIdx != 0">
			AND    K.FRANC_IDX = N.FRANC_IDX
		</if>
		AND    K.DOMAIN_IDX = #{domainIdx}
		AND    K.BRAND_IDX = #{brandIdx}
		<if test="francIdx != null and francIdx != '' and francIdx != 0">
			AND    K.FRANC_IDX = #{francIdx}
		</if>
		AND    NOTICE_IDX IN
		<foreach collection="checkboxArr" item="id" open="(" close=")" separator=",">
	        #{id}
	    </foreach>
	    ) A
     GROUP BY  A.DEVICE_CODE,
              A.SCHEDULE_VERSION_IDX,
              A.SCHEDULE_TYPE,
              A.MOD_REASON,
              A.REG_USER,
              A.REG_DATE,
              A.REG_USER,
              A.MOD_DATE
	</insert>

</mapper>