<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="OrderProd">

	<select id="OrderProd_ListCountOrderProd" parameterType="hashmap" resultType="int">
		/*
		  ID  : orderprod_sql.OrderProd_ListCountOrderProd
		  DEC : 상품 count 조회
		*/
		<!-- 시스템 관라지 일경우 -->
		<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
			SELECT COUNT(OP.DOMAIN_IDX) AS CNT
			FROM   ORDER_PROD OP
				   INNER JOIN franchisee f ON  f.DOMAIN_IDX = OP.DOMAIN_IDX AND f.BRAND_IDX = OP.BRAND_IDX AND f.FRANC_IDX = OP.FRANC_IDX AND ifnull(f.DEL_YN, 'N') = 'N'
      			   INNER JOIN brand b ON  b.DOMAIN_IDX = OP.DOMAIN_IDX AND b.BRAND_IDX = OP.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
			WHERE  IFNULL(OP.DEL_YN, 'N') = 'N'
			AND    OP.DOMAIN_IDX = #{domainIdx}
			<!-- 루트 조회 필요 -->
			<if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
				AND OP.BRAND_IDX = #{brandIdx}
			</if>
			<if test="francIdx != null and francIdx != '' and francIdx != 0">
				AND OP.FRANC_IDX = #{francIdx}
			</if>
			<if test="sSearch != null and sSearch != ''">
	            AND OP.PROD_DISPLAY_NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>
	     </if>
	     <!-- 시스템 관라지가 아닐경우(브랜드, 매장 관리자) -->
		 <if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
		 	SELECT COUNT(OP.DOMAIN_IDX) AS CNT
			FROM   ORDER_PROD OP
				   INNER JOIN franchisee f ON  f.DOMAIN_IDX = OP.DOMAIN_IDX AND f.BRAND_IDX = OP.BRAND_IDX AND f.FRANC_IDX = OP.FRANC_IDX AND ifnull(f.DEL_YN, 'N') = 'N'
      			   INNER JOIN brand b ON  b.DOMAIN_IDX = OP.DOMAIN_IDX AND b.BRAND_IDX = OP.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
			WHERE  IFNULL(OP.DEL_YN, 'N') = 'N'
			AND    OP.DOMAIN_IDX = #{domainIdx}
			/* 브랜드 관리자는 해당 브랜드에 포함된 모든 매장 포함되게 또는 선택한 매자만 */
			<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
				AND OP.BRAND_IDX = #{sessionBrandIdx}
			</if>
			<if test="francIdx != null and francIdx != '' and francIdx != 0">
				AND OP.FRANC_IDX = #{francIdx}
			</if>

			/* 매장 관리자는 자신이 속한 브랜드의 자기 매장만 보이게 */
			<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0003'">
				AND OP.BRAND_IDX = #{sessionBrandIdx}
				AND OP.FRANC_IDX = #{sessionFrancIdx}
			</if>
			<if test="sSearch != null and sSearch != ''">
	            AND OP.PROD_DISPLAY_NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>
		 </if>
	</select>

	<!-- 상품 리스트 조회 -->
	<select id="OrderProd_ListOrderProd" parameterType="qss.vo.OrderProdVo" resultType="qss.vo.OrderProdVo">
		/*
		  ID  : orderprod_sql.OrderProd_ListOrderProd
		  DEC : 상품 리스트 조회
		*/
		<include refid="Common.BeforeSQL"/>
		<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
			SELECT
				  OP.DOMAIN_IDX			/*도메인일련번호*/
				,OP.BRAND_IDX				/*브랜드일련번호*/
				,OP.FRANC_IDX				/*가맹점일련번호*/
				,OP.ORDER_PROD_IDX		/*주문 상품 일련번호*/
				,OP.PROD_NAME				/*상품명*/
				,OP.PROD_DISPLAY_NAME		/*상품 표시명*/
				,OP.PROD_CODE				/*상품 코드*/
				,OP.PROD_EN_NAME			/*상품 영문명*/
				,FORMAT(OP.PROD_AMOUNT,0) as PROD_AMOUNT	/*상품 가격*/
				,FORMAT(OP.PROD_DISCOUNT_AMOUNT,0) as PROD_DISCOUNT_AMOUNT	/*상품 할인 가격*/
				,OP.PROD_STOCK			/*상품 수량*/
				,OP.EVENT_PROD_YN			/*행사상품 여부*/
				,OP.EVENT_PROD_SCRIPT		/*행사상품 스크립트*/
				, date_format(OP.MOD_DATE, '%Y-%m-%d') AS MOD_DATE
				,OP.ACTIVE_YN
				,OP.PROD_BARCODE
				,OP.WEIGHT
				, (SELECT THUMBNAIL_PATH FROM FILE_CONTENT WHERE FILE_CONTENT.FILE_CONTENT_IDX = OP.PROD_IMAGE) AS THUMBNAIL_PATH
			FROM  ORDER_PROD OP
				  INNER JOIN franchisee f ON  f.DOMAIN_IDX = OP.DOMAIN_IDX AND f.BRAND_IDX = OP.BRAND_IDX AND f.FRANC_IDX = OP.FRANC_IDX AND ifnull(f.DEL_YN, 'N') = 'N'
      			  INNER JOIN brand b ON  b.DOMAIN_IDX = OP.DOMAIN_IDX AND b.BRAND_IDX = OP.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
			WHERE IFNULL(OP.DEL_YN, 'N') = 'N'
			<if test="activeYn != null and activeYn != ''">
	           AND    ifnull(OP.ACTIVE_YN, 'Y') = 'Y'
	        </if>
			AND   OP.DOMAIN_IDX = #{domainIdx}
			<!-- 루트 조회 필요 -->
			<if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
				AND OP.BRAND_IDX = #{brandIdx}
			</if>
			<if test="francIdx != null and francIdx != '' and francIdx != 0">
				AND OP.FRANC_IDX = #{francIdx}
			</if>
			<if test="sSearch != null and sSearch != ''">
	            AND OP.PROD_DISPLAY_NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>
         </if>
         <!-- 시스템 관라지가 아닐경우(브랜드, 매장 관리자) -->
		 <if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
			SELECT
				  OP.DOMAIN_IDX			/*도메인일련번호*/
				, OP.BRAND_IDX				/*브랜드일련번호*/
				, OP.FRANC_IDX				/*가맹점일련번호*/
				, OP.ORDER_PROD_IDX		/*주문 상품 일련번호*/
				, OP.PROD_NAME				/*상품명*/
				, OP.PROD_DISPLAY_NAME		/*상품 표시명*/
				, OP.PROD_CODE				/*상품 코드*/
				, OP.PROD_EN_NAME			/*상품 영문명*/
				, FORMAT(OP.PROD_AMOUNT,0) as PROD_AMOUNT	/*상품 가격*/
				, FORMAT(OP.PROD_DISCOUNT_AMOUNT,0) as PROD_DISCOUNT_AMOUNT	/*상품 할인 가격*/
				, OP.PROD_STOCK			/*상품 수량*/
				, OP.EVENT_PROD_YN			/*행사상품 여부*/
				, OP.EVENT_PROD_SCRIPT		/*행사상품 스크립트*/
				, date_format(OP.MOD_DATE, '%Y-%m-%d') AS MOD_DATE
				, OP.ACTIVE_YN
				, OP.PROD_BARCODE
				, OP.WEIGHT
				, (SELECT THUMBNAIL_PATH FROM FILE_CONTENT WHERE FILE_CONTENT.FILE_CONTENT_IDX = OP.PROD_IMAGE) AS THUMBNAIL_PATH
			FROM  ORDER_PROD OP
				  INNER JOIN franchisee f ON  f.DOMAIN_IDX = OP.DOMAIN_IDX AND f.BRAND_IDX = OP.BRAND_IDX AND f.FRANC_IDX = OP.FRANC_IDX AND ifnull(f.DEL_YN, 'N') = 'N'
      			  INNER JOIN brand b ON  b.DOMAIN_IDX = OP.DOMAIN_IDX AND b.BRAND_IDX = OP.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
			WHERE IFNULL(OP.DEL_YN, 'N') = 'N'
			AND   OP.DOMAIN_IDX = #{domainIdx}
			<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
			 	/* 브랜드 관리자는 해당 브랜드에 포함된 모든 매장 포함되게 또는 선택한 매장만 */
				AND OP.BRAND_IDX = #{sessionBrandIdx}
				<if test="francIdx != null and francIdx != '' and francIdx != 0">
				AND OP.FRANC_IDX = #{francIdx}
				</if>
			 </if>

			 <if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0003'">
			 	/* 매장 관리자는 자신이 속한 브랜드의 자기 매장만 보이게 */
			 	AND OP.BRAND_IDX = #{sessionBrandIdx}
				AND OP.FRANC_IDX = #{sessionFrancIdx}
			 </if>
			 <if test="sSearch != null and sSearch != ''">
	            AND OP.PROD_DISPLAY_NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>

		 </if>
		 <if test="sSortName == null or sSortName == ''">
<!-- 		 ORDER BY OP.MOD_DATE -->
		 </if>
        <include refid="Common.AfterSQL"/>
	</select>

	<select id="OrderProd_ViewOrderProd" parameterType="qss.vo.OrderProdVo" resultType="qss.vo.OrderProdVo">
		/*
		  ID  : orderprod_sql.OrderProd_ViewOrderProd
		  DEC : 상품 상세 조회
		*/
		SELECT DOMAIN_IDX
		     , BRAND_IDX				/*브랜드일련번호*/
			 , FRANC_IDX				/*가맹점일련번호*/
			 , ORDER_PROD_IDX		/*주문 상품 일련번호*/
			 , PROD_NAME				/*상품명*/
			 , PROD_DISPLAY_NAME		/*상품 표시명*/
			 , PROD_CODE				/*상품 코드*/
			 , PROD_EN_NAME			/*상품 영문명*/
			 , FORMAT(PROD_AMOUNT,0) as PROD_AMOUNT			/*상품 가격*/
			 , FORMAT(PROD_DISCOUNT_AMOUNT,0) AS PROD_DISCOUNT_AMOUNT	/*상품 할인 가격*/
			 , PROD_STOCK			/*상품 수량*/
			 , EVENT_PROD_YN			/*행사상품 여부*/
			 , EVENT_PROD_SCRIPT		/*행사상품 스크립트*/
			 , ACTIVE_YN
			 , PROD_IMAGE
			 , (SELECT SAVE_PATH FROM FILE_CONTENT WHERE FILE_CONTENT.FILE_CONTENT_IDX = OP.PROD_IMAGE) AS PROD_IMAGE_PATH
			 , PROD_BARCODE
			 , FORMAT(WEIGHT,0) AS WEIGHT
		FROM   ORDER_PROD OP
		WHERE  IFNULL(DEL_YN, 'N') = 'N'
		AND    DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
		AND    ORDER_PROD_IDX = #{orderProdIdx}
    </select>

	<update id="OrderProd_InsertOrderProd" parameterType="qss.vo.OrderProdVo">
		/*
		  ID  : orderprod_sql.OrderProd_InsertOrderProd
		  DEC : 상품 저장
		*/
		<selectKey keyProperty="returnIdx" resultType="biginteger" order="BEFORE">
			SELECT IFNULL(MAX(ORDER_PROD_IDX) + 1, '1')
			FROM   ORDER_PROD
			WHERE  DOMAIN_IDX = #{domainIdx}
			AND    BRAND_IDX = #{brandIdx}
			AND    FRANC_IDX = #{francIdx}
		</selectKey>
		INSERT INTO ORDER_PROD (
		   DOMAIN_IDX
		  ,BRAND_IDX
		  ,FRANC_IDX
		  ,ORDER_PROD_IDX
		  ,PROD_NAME
		  ,PROD_DISPLAY_NAME
		  ,PROD_CODE
		  ,PROD_EN_NAME
		  ,PROD_AMOUNT
		  ,PROD_STOCK
		  ,EVENT_PROD_YN
		  ,EVENT_PROD_SCRIPT
		  ,PROD_BARCODE
		  ,REG_USER
		  ,REG_DATE
		  ,MOD_USER
		  ,MOD_DATE
		  ,PROD_DISCOUNT_AMOUNT
		  ,PROD_IMAGE
		  ,DEL_YN
		  ,ACTIVE_YN
		  ,WEIGHT
		) VALUES (
		   #{domainIdx}
		  ,#{brandIdx}
		  ,#{francIdx}
		  ,#{returnIdx}
		  ,#{prodName}
		  ,#{prodDisplayName}
		  ,#{prodCode}
		  ,#{prodEnName}
		  ,#{prodAmount}
		  ,#{prodStock}
		  ,#{eventProdYn}
		  ,#{eventProdScript}
		  ,#{prodBarcode}
		  , #{regUser}
		  , now()
		  , #{regUser}
		  , now()
		  ,#{prodDiscountAmount}
		  ,#{prodImage}
		  ,'N'
		  ,#{activeYn}
		  ,#{weight}
		)
	</update>

	<update id="OrderProd_UpdateOrderProd" parameterType="qss.vo.OrderProdVo">
		/*
		  ID  : orderprod_sql.OrderProd_UpdateOrderProd
		  DEC : 상품 수정
		*/
		UPDATE ORDER_PROD
		SET     PROD_NAME = #{prodName}
			  , PROD_DISPLAY_NAME = #{prodDisplayName}
			  , PROD_CODE = #{prodCode}
			  , PROD_EN_NAME = #{prodEnName}
			  , PROD_AMOUNT = #{prodAmount}
			  , PROD_STOCK = #{prodStock}
			  , EVENT_PROD_YN = #{eventProdYn}
			  , EVENT_PROD_SCRIPT = #{eventProdScript}
			  , MOD_USER = #{regUser}
			  , MOD_DATE = now()
			  , PROD_DISCOUNT_AMOUNT = #{prodDiscountAmount}
			  , PROD_IMAGE = #{prodImage}
			  , ACTIVE_YN = #{activeYn}
			  , PROD_BARCODE = #{prodBarcode}
		      , WEIGHT = #{weight}
		WHERE   DOMAIN_IDX = #{domainIdx}
		  AND   BRAND_IDX = #{brandIdx}
		  AND   FRANC_IDX = #{francIdx}
		  AND   ORDER_PROD_IDX = #{orderProdIdx}
	</update>

	<update id="OrderProd_DeleteOrderProd"  parameterType="qss.vo.OrderProdVo" >
		/*
		  ID  : orderprod_sql.OrderProd_DeleteOrderProd
		  DEC : 상품 삭제
		*/
		UPDATE ORDER_PROD
		SET    DEL_YN = 'Y'
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		 AND   FRANC_IDX = #{francIdx}
		AND    ORDER_PROD_IDX IN
		<foreach collection="checkboxArr" item="id" open="(" close=")" separator=",">
	        #{id}
	    </foreach>
	</update>

	<update id="OrderProd_ActiveOrderProd"  parameterType="qss.vo.OrderProdVo" >
		/*
		  ID  : orderprod_sql.OrderProd_ActiveOrderProd
		  DEC : 상품 활성화
		*/
		UPDATE ORDER_PROD
		SET    ACTIVE_YN = #{activeYn}
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
		AND    ORDER_PROD_IDX = #{orderProdIdx}
	</update>

	<insert id="OrderProd_InsertScheduleVersion" parameterType="qss.vo.OrderProdVo">
		/*
		  ID  : orderprod_sql.OrderProd_InsertScheduleVersion
		  DEC : 상품 기준  주문조회 스케줄버전 추가
		*/
		INSERT INTO SCHEDULE_VERSION
		(
		  DEVICE_CODE
		 ,SCHEDULE_VERSION_IDX
		 ,SCHEDULE_TYPE
		 ,MOD_REASON
		 ,REG_USER
		 ,REG_DATE
		 ,MOD_USER
		 ,MOD_DATE
		)
		SELECT *
	    FROM
	    (
			SELECT K.DEVICE_CODE
			      ,(
			      		SELECT IFNULL(MAX(SCHEDULE_VERSION_IDX) + 1, 1)
			      		FROM   SCHEDULE_VERSION
			      		WHERE  DEVICE_CODE = K.DEVICE_CODE
<!-- 			      		AND    SCHEDULE_TYPE = #{scheduleType} -->
			      	) AS SCHEDULE_VERSION_IDX
			      ,#{scheduleType} AS SCHEDULE_TYPE
			      ,(
			      		SELECT CODE_NAME
			      		FROM   SYSTEM_CODE
			      		WHERE  CODE_GROUP = 'SCH0000' AND  CODE_VALUE = #{scheduleType}
			      		AND    IFNULL(DEL_YN, 'N') = 'N'
			      	) AS MOD_REASON
			      ,#{regUser} AS REG_USER
			      ,now() AS REG_DATE
			      ,#{regUser} AS MOD_USER
			      ,now() AS MOD_DATE
			FROM   ORDER_PROD OP
			INNER  JOIN KIOSK K
	        ON     K.DOMAIN_IDX = OP.DOMAIN_IDX
			AND    K.BRAND_IDX = OP.BRAND_IDX
			AND    K.FRANC_IDX = OP.FRANC_IDX
	        AND    K.DOMAIN_IDX = #{domainIdx}
			AND    K.BRAND_IDX = #{brandIdx}
			AND    K.FRANC_IDX = #{francIdx}
			AND    IFNULL(K.DEL_YN, 'N') = 'N'
<!-- 			AND    ( -->
<!-- 						SELECT count(*)  -->
<!-- 						FROM ORDER_SCREEN  -->
<!-- 						WHERE DOMAIN_IDX = OST.DOMAIN_IDX  -->
<!-- 						AND BRAND_IDX = OST.BRAND_IDX  -->
<!-- 						AND FRANC_IDX = OST.FRANC_IDX  -->
<!-- 						AND ORDER_SCREEN_IDX = OST.ORDER_SCREEN_IDX -->
<!--             			AND IFNULL(DEL_YN, 'N') = 'N' -->
<!-- 			        ) &gt; 0 -->

		     ) A
            GROUP BY DEVICE_CODE, SCHEDULE_TYPE, MOD_REASON, REG_USER, REG_DATE, MOD_USER, MOD_DATE
	</insert>

	<insert id="OrderProd_InsertDeviceScheduleVersion" parameterType="qss.vo.OrderProdVo">
		/*
		  ID  : orderprod_sql.OrderProd_InsertScheduleVersion
		  DEC : 주문화면 기준  주문조회 스케줄버전 추가
		*/
		INSERT INTO SCHEDULE_VERSION
		(
		  DEVICE_CODE
		 ,SCHEDULE_VERSION_IDX
		 ,SCHEDULE_TYPE
		 ,MOD_REASON
		 ,REG_USER
		 ,REG_DATE
		 ,MOD_USER
		 ,MOD_DATE
		)
		SELECT *
	    FROM
	    (
			SELECT K.DEVICE_CODE
			      ,(
			      		SELECT IFNULL(MAX(SCHEDULE_VERSION_IDX) + 1, 1)
			      		FROM   SCHEDULE_VERSION
			      		WHERE  DEVICE_CODE = K.DEVICE_CODE
<!-- 			      		AND    SCHEDULE_TYPE = #{scheduleType} -->
			      	) AS SCHEDULE_VERSION_IDX
			      ,#{scheduleType} AS SCHEDULE_TYPE
			      ,(
			      		SELECT CODE_NAME
			      		FROM   SYSTEM_CODE
			      		WHERE  CODE_GROUP = 'SCH0000' AND  CODE_VALUE = #{scheduleType}
			      		AND    IFNULL(DEL_YN, 'N') = 'N'
			      	) AS MOD_REASON
			      ,#{regUser} AS REG_USER
			      ,now() AS REG_DATE
			      ,#{regUser} AS MOD_USER
			      ,now() AS MOD_DATE
			FROM   ORDER_PROD OP
			INNER  JOIN order_screen_menu_item OS
			ON     OS.DOMAIN_IDX = OP.DOMAIN_IDX
			AND    OS.BRAND_IDX = OP.BRAND_IDX
			AND    OS.FRANC_IDX = OP.FRANC_IDX
      		AND    OS.ORDER_PROD_IDX = OP.ORDER_PROD_IDX
			<if test="checkboxArr != null and checkboxArr != '' ">
				AND    OP.ORDER_PROD_IDX IN
				<foreach collection="checkboxArr" item="id" open="(" close=")" separator=",">
			        #{id}
			    </foreach>
			</if>
			INNER  JOIN order_screen_target OST
			ON     OS.DOMAIN_IDX = OST.DOMAIN_IDX
			AND    OS.BRAND_IDX = OST.BRAND_IDX
			AND    OS.FRANC_IDX = OST.FRANC_IDX
	        AND    OS.ORDER_SCREEN_IDX = OST.ORDER_SCREEN_IDX
	        INNER  JOIN KIOSK K
	        ON     K.DOMAIN_IDX = OST.DOMAIN_IDX
			AND    K.BRAND_IDX = OST.BRAND_IDX
			AND    K.FRANC_IDX = OST.FRANC_IDX
	        AND    K.DEVICE_IDX = OST.DEVICE_IDX
	        AND    K.DOMAIN_IDX = #{domainIdx}
			AND    K.BRAND_IDX = #{brandIdx}
			AND    K.FRANC_IDX = #{francIdx}
			AND    IFNULL(K.DEL_YN, 'N') = 'N'
			AND    (
						SELECT count(*)
						FROM ORDER_SCREEN
						WHERE DOMAIN_IDX = OST.DOMAIN_IDX
						AND BRAND_IDX = OST.BRAND_IDX
						AND FRANC_IDX = OST.FRANC_IDX
						AND ORDER_SCREEN_IDX = OST.ORDER_SCREEN_IDX
            			AND IFNULL(DEL_YN, 'N') = 'N'
			        ) &gt; 0

		     ) A
            GROUP BY DEVICE_CODE, SCHEDULE_TYPE, MOD_REASON, REG_USER, REG_DATE, MOD_USER, MOD_DATE
	</insert>

	<select id="OrderProd_OverlapCountOrderProd" parameterType="qss.vo.OrderProdVo" resultType="int">
		/*
		  ID    : orderprod_sql.OrderProd_OverlapCountOrderProd
		  DEC   : 주문상품 코드 중복체크
		*/
		SELECT  count(*)
		FROM    ORDER_PROD
		WHERE   ifnull(DEL_YN, 'N') = 'N'
		AND     DOMAIN_IDX = #{domainIdx}
		AND     BRAND_IDX = #{brandIdx}
		AND     FRANC_IDX = #{francIdx}
		AND     PROD_CODE = #{prodCode}
		<!-- 수정시 필요 -->
		<if test="orderProdIdx != null and orderProdIdx != '' and orderProdIdx != 0">
				 AND ORDER_PROD_IDX != #{orderProdIdx}
		</if>
	</select>

	<select id="OrderProd_OverlapCountProdBarcode" parameterType="qss.vo.OrderProdVo" resultType="int">
		/*
		  ID    : orderprod_sql.OrderProd_OverlapCountOrderProd
		  DEC   : 주문상품 바코드 중복체크
		*/
		SELECT  count(*)
		FROM    ORDER_PROD
		WHERE   ifnull(DEL_YN, 'N') = 'N'
		AND     DOMAIN_IDX = #{domainIdx}
		AND     BRAND_IDX = #{brandIdx}
		AND     FRANC_IDX = #{francIdx}
		AND     PROD_BARCODE = #{prodBarcode}
		AND     PROD_BARCODE != ''
		<!-- 수정시 필요 -->
		<if test="orderProdIdx != null and orderProdIdx != '' and orderProdIdx != 0">
				 AND ORDER_PROD_IDX != #{orderProdIdx}
		</if>
	</select>


	<select id="OrderProd_ResultOptionProd" parameterType="qss.vo.OrderProdVo" resultType="qss.vo.OptionProdVo">
		/*
		ID : orderprod_sql.OrderProd_ResultOptionProd
		DEC : 옵션 상품 목록 조회
		*/
		
		SELECT OPOT.ORDER_PROD_IDX
		      ,OPOT.OPTION_PROD_IDX
		      ,OPTION_PROD_NAME
		      ,OPTION_PROD_DISPLAY_NAME
		      ,OPTION_PROD_EN_NAME
		      ,FORMAT(OPTION_PROD_AMOUNT,0) OPTION_PROD_AMOUNT
		FROM  ORDER_PROD_OPTION_TARGET OPOT
		LEFT  JOIN OPTION_PROD OP
			  ON OPOT.DOMAIN_IDX = OP.DOMAIN_IDX AND OPOT.BRAND_IDX = OP.BRAND_IDX AND OPOT.FRANC_IDX = OP.FRANC_IDX AND OPOT.OPTION_PROD_IDX = OP.OPTION_PROD_IDX
		WHERE OPOT.DOMAIN_IDX = #{domainIdx} AND OPOT.BRAND_IDX = #{brandIdx} AND OPOT.FRANC_IDX = #{francIdx}
		AND   ifnull(OP.DEL_YN, 'N') = 'N'
		AND   OPOT.ORDER_PROD_IDX = #{orderProdIdx}
		ORDER BY OPOT.ORDER_SEQ
	</select>
	
	<delete id="OrderProd_DeleteOrderProdOptionTarget" parameterType="qss.vo.OrderProdVo">
		/*
		ID : orderprod_sql.OrderProd_DeleteOrderProdOptionTarget
		DEC : 옵션 상품 타겟 정보 삭제
		*/
		<![CDATA[
			DELETE FROM ORDER_PROD_OPTION_TARGET
			WHERE DOMAIN_IDX = #{domainIdx} AND BRAND_IDX = #{brandIdx} AND FRANC_IDX = #{francIdx}
			    AND ORDER_PROD_IDX = #{orderProdIdx}
		]]>
	</delete>
	
	<insert id="OrderProd_InsertOrderProdOptionTarget" parameterType="qss.vo.OrderProdVo" >
		/*
		ID : orderprod_sql.OrderProd_InsertOrderProdOptionTarget
		DEC : 옵션 상품 정보 등록
		*/
		   INSERT INTO ORDER_PROD_OPTION_TARGET
				(
					DOMAIN_IDX,
					BRAND_IDX,								
					FRANC_IDX,								
					ORDER_PROD_IDX,								
					OPTION_PROD_IDX,								
					REG_USER,								
					REG_DATE,								
					MOD_USER,								
					MOD_DATE,								
					ORDER_SEQ					
				)
			VALUES
				(
					#{domainIdx},
       			    #{brandIdx},
       			    #{francIdx},
       				#{orderProdIdx},
					#{optionProdIdx},
					#{regUser},
		            NOW(),
		            #{regUser},
		            NOW(),
		            #{orderSeq}
				)
	</insert>
	
	

</mapper>