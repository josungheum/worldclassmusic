<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="KioskClient">

	<select id="KioskClient_ListKioskClient" parameterType="qss.vo.KioskClientVo" resultType="qss.vo.KioskClientVo">
		/*
		  ID  : KioskClient_sql.KioskClient_ListKioskClient
		  DEC : 클라이언트 목록 조회
		*/
		<include refid="Common.BeforeSQL"/>
		SELECT   KIOSK_CLIENT_IDX
		       , VERSION
			   , FILE_NAME
               , CHANGES
			   , DETAIL
               , DIST_COUNT
               , date_format(REG_DATE, '%Y-%m-%d') AS REG_DATE
               , date_format(MOD_DATE, '%Y-%m-%d') AS MOD_DATE
		FROM     KIOSK_CLIENT
		WHERE    IFNULL(DEL_YN, 'N') = 'N'
		<if test="sSearch != null and sSearch != ''">
            AND VERSION LIKE CONCAT('%',#{sSearch},'%')
        </if>
        <if test="sSortName == null or sSortName == ''">
<!-- 		ORDER BY MOD_DATE -->
		</if>
		 <include refid="Common.AfterSQL"/>
	</select>

	<select id="KioskClient_ListCountKioskClient" parameterType="qss.vo.KioskClientVo" resultType="int">
		/*
		  ID  : KioskClient_sql.KioskClient_ListCountKioskClient
		  DEC : 클라이언트 카운터
		*/
		SELECT COUNT(*)
		FROM   KIOSK_CLIENT
		WHERE  IFNULL(DEL_YN, 'N') = 'N'
		AND VERSION LIKE CONCAT('%',#{sSearch},'%')

	</select>

	<select id="KioskClient_ViewKioskClient" parameterType="qss.vo.KioskClientVo" resultType="qss.vo.KioskClientVo">
		/*
		  ID  : KioskClient_sql.KioskClient_ViewKioskClient
		  DEC : 클라이언트 상세 조회
		*/
		SELECT   KIOSK_CLIENT_IDX
		       , VERSION
			   , FILE_NAME
               , CHANGES
			   , DETAIL
               , DIST_COUNT
               , date_format(REG_DATE, '%Y-%m-%d') AS REG_DATE
               , date_format(MOD_DATE, '%Y-%m-%d') AS MOD_DATE
		FROM     KIOSK_CLIENT
		WHERE    IFNULL(DEL_YN, 'N') = 'N'
		AND      KIOSK_CLIENT_IDX = #{kioskClientIdx}
	</select>

	<insert id="KioskClient_InsertKioskClient" parameterType="qss.vo.KioskClientVo">
	    /*
		  ID  : KioskClient_sql.KioskClient_InsertKioskClient
		  DEC : 클라이언트 저장
		*/
		<selectKey keyProperty="kioskClientIdx" resultType="biginteger" order="BEFORE">
			SELECT IFNULL(MAX(KIOSK_CLIENT_IDX) + 1, '1') AS KIOSK_CLIENT_IDX
			FROM   KIOSK_CLIENT
		</selectKey>
		INSERT INTO KIOSK_CLIENT (
		   KIOSK_CLIENT_IDX
		  ,VERSION
		  ,FILE_NAME
		  ,CHANGES
		  ,DETAIL
		  ,DIST_COUNT
		  ,REG_USER
		  ,REG_DATE
		  ,MOD_USER
		  ,MOD_DATE
		  ,DEL_YN
		) VALUES
		(
		   #{kioskClientIdx}
		  ,#{version}
		  ,#{fileName}
		  ,#{changes}
		  ,#{detail}
		  ,0
		  ,#{regUser}
		  ,now()
		  ,#{regUser}
		  ,now()
		  ,'N'
		)
	</insert>

	<update id="KioskClient_UpdateKioskClient" parameterType="qss.vo.KioskClientVo" >
	    /*
		  ID  : KioskClient_sql.KioskClient_UpdateKioskClient
		  DEC : 클라이언트 수정
		*/
		UPDATE KIOSK_CLIENT
		SET    FILE_NAME = #{fileName}
		     , DETAIL = #{detail}
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  KIOSK_CLIENT_IDX = #{kioskClientIdx}
	</update>

	<update id="KioskClient_DeleteKioskClient" parameterType="qss.vo.KioskClientVo" >
	    /*
		  ID  : KioskClient_sql.KioskClient_DeleteKioskClient
		  DEC : 클라이언트 삭제
		*/
		UPDATE KIOSK_CLIENT
		SET    DEL_YN = 'Y'
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  KIOSK_CLIENT_IDX IN
		<foreach collection="checkboxArr" item="kioskClientIdx" open="(" close=")" separator=",">
	        #{kioskClientIdx}
	    </foreach>
	</update>

	<select id="KioskClient_SearchKioskTree" parameterType="qss.vo.KioskClientVo" resultType="hashmap">
		/*
		  ID  : KioskClient_sql.KioskClient_SearchKioskTree
		  DEC : 클라이언트 트리 조회
		*/
		SELECT  '1' AS DEPTH
		      , 'DOMAIN' AS DEPTH_NAME
		      , DOMAIN_IDX AS IDX
		      , DOMAIN_NAME AS NAME
		      , '0' AS PARENT_IDX
		      , '0' AS CHECKED
		FROM DOMAIN
		<if test="domainIdx != null and domainIdx != null and domainIdx != 0">
			WHERE DOMAIN_IDX = #{domainIdx}
		</if>
		UNION ALL
		SELECT  '2'
		      , 'BRAND'
		      , CONCAT(DOMAIN_IDX, '_', BRAND_IDX)
		      , NAME
		      , DOMAIN_IDX
		      , '0'
		FROM(
	          SELECT  A.*
	                 ,(SELECT COUNT(*) FROM SITEGROUP WHERE DOMAIN_IDX = A.DOMAIN_IDX AND BRAND_IDX = A.BRAND_IDX AND ifnull(DEL_YN, 'N') = 'N' AND    ifnull(ACTIVE_YN, 'N') = 'Y') AS GROUP_COUNT
                     ,(SELECT COUNT(*) FROM KIOSK WHERE DOMAIN_IDX = A.DOMAIN_IDX AND BRAND_IDX = A.BRAND_IDX AND ifnull(DEL_YN, 'N') = 'N' AND    ifnull(ACTIVE_YN, 'N') = 'Y') AS KIOSK_COUNT
			  FROM   BRAND A
	          WHERE  ifnull(DEL_YN, 'N') = 'N'
	          AND    ifnull(ACTIVE_YN, 'N') = 'Y'
	          <if test="domainIdx != null and domainIdx != null and domainIdx != 0">
	          	AND A.DOMAIN_IDX = #{domainIdx}
	          </if>
	    	  <if test="brandIdx != null and brandIdx != null and brandIdx != 0">
				AND A.BRAND_IDX = #{brandIdx}
			  </if>
	        ) D
    	WHERE KIOSK_COUNT > 0  AND GROUP_COUNT > 0
		
		UNION ALL
		SELECT  '3'
		     , 'GROUP'
		     , CONCAT(DOMAIN_IDX, '_', BRAND_IDX, '_', GROUP_IDX)
		     , GROUP_NAME
		     , CONCAT(DOMAIN_IDX, '_', BRAND_IDX)
		     , '0'
		FROM(
              SELECT  A.*
                 ,(SELECT COUNT(*) FROM FRANCHISEE WHERE DOMAIN_IDX = A.DOMAIN_IDX AND BRAND_IDX = A.BRAND_IDX AND ifnull(DEL_YN, 'N') = 'N' AND    ifnull(ACTIVE_YN, 'N') = 'Y') AS FRANC_COUNT
				 ,(SELECT COUNT(*) FROM KIOSK WHERE DOMAIN_IDX = A.DOMAIN_IDX AND BRAND_IDX = A.BRAND_IDX AND ifnull(DEL_YN, 'N') = 'N' AND    ifnull(ACTIVE_YN, 'N') = 'Y') AS KIOSK_COUNT
	          FROM   SITEGROUP A
              WHERE  ifnull(A.DEL_YN, 'N') = 'N'
              AND    ifnull(A.ACTIVE_YN, 'N') = 'Y'
              <if test="domainIdx != null and domainIdx != null and domainIdx != 0">
	          	AND A.DOMAIN_IDX = #{domainIdx}
	          </if>
	    	  <if test="brandIdx != null and brandIdx != null and brandIdx != 0">
				AND A.BRAND_IDX = #{brandIdx}
			  </if>
             ) D
		WHERE KIOSK_COUNT > 0  AND FRANC_COUNT > 0
		
		UNION ALL
		SELECT  '4'
		     , 'FRANCHISEE'
		     , CONCAT(DOMAIN_IDX, '_', BRAND_IDX, '_', GROUP_IDX, '_', FRANC_IDX)
		     , FRANC_NAME
		     , CONCAT(DOMAIN_IDX, '_', BRAND_IDX, '_', GROUP_IDX)
		     , '0'
		FROM(
              SELECT  A.*
                 ,(SELECT COUNT(*) FROM KIOSK WHERE DOMAIN_IDX = A.DOMAIN_IDX AND BRAND_IDX = A.BRAND_IDX AND FRANC_IDX = A.FRANC_IDX AND ifnull(DEL_YN, 'N') = 'N' AND    ifnull(ACTIVE_YN, 'N') = 'Y') AS KIOSK_COUNT
	          FROM   FRANCHISEE A
              WHERE  ifnull(A.DEL_YN, 'N') = 'N'
              AND    ifnull(A.ACTIVE_YN, 'N') = 'Y'
              <if test="domainIdx != null and domainIdx != null and domainIdx != 0">
	          	AND A.DOMAIN_IDX = #{domainIdx}
	          </if>
	    	  <if test="brandIdx != null and brandIdx != null and brandIdx != 0">
				AND A.BRAND_IDX = #{brandIdx}
			  </if>
			  <if test="francIdx != null and francIdx != null and francIdx != 0">
				AND A.FRANC_IDX = #{francIdx}
			  </if>
             ) D
    	WHERE KIOSK_COUNT > 0
    	UNION ALL
		SELECT  '5'
		     , 'KIOSK'
		     , CONCAT(DOMAIN_IDX, '_', BRAND_IDX, '_', GROUP_IDX, '_', FRANC_IDX, '_', DEVICE_IDX)
		     , DEVICE_NAME
		     , CONCAT(DOMAIN_IDX, '_', BRAND_IDX, '_', GROUP_IDX, '_', FRANC_IDX)
		     , cast(DEVICE_COUNT as char(1)) 
		FROM(
	          SELECT  A.*
	                 ,(SELECT COUNT(*) FROM DISTRIBUTE WHERE DOMAIN_IDX = A.DOMAIN_IDX AND BRAND_IDX = A.BRAND_IDX AND FRANC_IDX = A.FRANC_IDX AND DEVICE_IDX = A.DEVICE_IDX AND ifnull(DEL_YN, 'N') = 'N' AND ifnull(A.ACTIVE_YN, 'N') = 'Y' AND KIOSK_CLIENT_IDX = #{kioskClientIdx}) AS DEVICE_COUNT
	                 ,(SELECT GROUP_IDX FROM FRANCHISEE WHERE DOMAIN_IDX = A.DOMAIN_IDX AND BRAND_IDX = A.BRAND_IDX AND FRANC_IDX = A.FRANC_IDX AND DEL_YN = 'N' AND ACTIVE_YN = 'Y') AS GROUP_IDX
			  FROM   KIOSK A
	          WHERE  ifnull(A.DEL_YN, 'N') = 'N'
	          AND    ifnull(A.ACTIVE_YN, 'N') = 'Y'
	          <if test="domainIdx != null and domainIdx != null and domainIdx != 0">
	          	AND A.DOMAIN_IDX = #{domainIdx}
	          </if>
	    	  <if test="brandIdx != null and brandIdx != null and brandIdx != 0">
				AND A.BRAND_IDX = #{brandIdx}
			  </if>
			  <if test="francIdx != null and francIdx != null and francIdx != 0">
				AND A.FRANC_IDX = #{francIdx}
			  </if>
	        ) D


	</select>

	<update id="KioskClient_DeleteDistribute" parameterType="qss.vo.KioskClientVo">
	    /*
		  ID  : KioskClient_sql.KioskClient_DeleteDistribute
		  DEC : 배포 삭제
		*/
		DELETE FROM DISTRIBUTE
		WHERE KIOSK_CLIENT_IDX = #{kioskClientIdx}
	</update>

	<update id="KioskClient_CountUpdateKioskClient" parameterType="qss.vo.KioskClientVo">
	    /*
		  ID  : KioskClient_sql.KioskClient_CountUpdateKioskClient
		  DEC : 배포 건수 수정
		*/
		UPDATE KIOSK_CLIENT
		SET    CHANGES = #{changes}
		     , DIST_COUNT = #{distCount}
		     , MOD_DATE = now()
		     , MOD_USER = #{regUser}
		WHERE  KIOSK_CLIENT_IDX = #{kioskClientIdx}
	</update>

	<update id="KioskClient_InsertDistribute" parameterType="qss.vo.KioskClientVo">
		/*
		  ID  : KioskClient_sql.Distribute_InsertDistribute
		  DEC : 배포 추가
		*/
		INSERT INTO DISTRIBUTE (
		   DOMAIN_IDX
		  ,BRAND_IDX
		  ,FRANC_IDX
		  ,DEVICE_IDX
		  ,KIOSK_CLIENT_IDX
		  ,REG_USER
		  ,REG_DATE
		  ,MOD_USER
		  ,MOD_DATE
		) VALUES (
		   #{domainIdx}
		  ,#{brandIdx}
		  ,#{francIdx}
		  ,#{deviceIdx}
		  ,#{kioskClientIdx}
		  ,#{regUser}
		  ,now()
		  ,#{regUser}
		  ,now()
		)
	</update>



	<select id="KioskClient_OverlapCountKioskClient" parameterType="qss.vo.KioskClientVo" resultType="int">
		/*
		  ID    : KioskClient_sql.KioskClient_OverlapCountKioskClient
		  DEC   : 코드 중복체크
		*/
		SELECT  COUNT(*)
		FROM    KIOSK_CLIENT
		WHERE   VERSION = #{version}
		AND     DEL_YN = 'N'
		<!-- 수정시 필요 -->
		<if test="kioskClientIdx != null and kioskClientIdx != '' and kioskClientIdx != 0">
			AND KIOSK_CLIENT_IDX != #{kioskClientIdx}
		</if>

	</select>

</mapper>