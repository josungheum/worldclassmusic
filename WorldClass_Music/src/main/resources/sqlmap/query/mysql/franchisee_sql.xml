<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="FranchiseeManagement">

	<select id="Franchisee_ViewFranchisee" parameterType="qss.vo.FranchiseeVo" resultType="qss.vo.FranchiseeVo">
		 /*
		  ID  : franchisee_sql.Franchisee_ViewFranchisee
		  DEC : 사이트 기본 속성 조회
		*/
		SELECT  DOMAIN_IDX
		      , BRAND_IDX
		      , GROUP_IDX
              , FRANC_IDX
		      , FRANC_CODE
              , SAP_MS_CD
		      , FRANC_NAME
		      , date_format(REG_DATE, '%Y-%m-%d') AS REG_DATE
         	  , date_format(MOD_DATE, '%Y-%m-%d') AS MOD_DATE
         	  , ACTIVE_YN
         	  , (SELECT GROUP_NAME FROM sitegroup WHERE GROUP_IDX = A.GROUP_IDX AND BRAND_IDX = A.BRAND_IDX) AS groupName
		FROM    franchisee A
		WHERE   ifnull(DEL_YN, 'N') = 'N'
		AND     DOMAIN_IDX = #{domainIdx}
		AND     BRAND_IDX = #{brandIdx}
		AND     FRANC_IDX = #{francIdx}
	</select>

	<update id="Franchisee_UpdateFranchisee" parameterType="qss.vo.FranchiseeVo" >
		/*
		  ID  : franchisee_sql.Franchisee_UpdateFranchisee
		  DEC : 사이트 기본 속성 수정
		*/
		UPDATE franchisee
		set    MOD_USER = #{regUser}
		     , MOD_DATE = now()
		     , GROUP_IDX = #{groupIdx}
		     , FRANC_CODE = #{francCode}
		     , FRANC_NAME = #{francName}
		     , ACTIVE_YN = #{activeYn}
		     , SAP_MS_CD = #{sapMsCd}
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}

	</update>

	<delete id="Franchisee_DeleteFrancPaymentType" parameterType="qss.vo.BrandPaymentTypeVo">
		/*
		  ID  : franchisee_sql.FrancPaymentType_delete
		  DEC : 사이트 형태 삭제
		*/
		DELETE FROM brand_payment_type
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
		AND    BRAND_ONLY_YN = 'N'
	</delete>

	<insert id="Franchisee_InsertFrancPaymentType" parameterType="qss.vo.BrandPaymentTypeVo">
		/*
		  ID  : franchisee_sql.FrancPaymentType_insert
		  DEC : 사이트 형태 저장
		*/
		<selectKey resultType="BigInteger" keyProperty="payTypeIdx" order="BEFORE">
	        SELECT IFNULL(MAX(PAY_TYPE_IDX) + 1, '1')
			FROM   brand_payment_type
			WHERE  DOMAIN_IDX = #{domainIdx}
			AND    BRAND_IDX = #{brandIdx}
	    </selectKey>
	    INSERT INTO brand_payment_type
		   (
			   DOMAIN_IDX
			 , BRAND_IDX
			 , PAY_TYPE_IDX
			 , PAY_TYPE_GROUP
			 , PAY_TYPE
			 , BRAND_ONLY_YN
			 , FRANC_IDX
			 , REG_USER
			 , REG_DATE
			 , MOD_USER
			 , MOD_DATE
			)
			VALUES
			(
				#{domainIdx}
			  , #{brandIdx}
			  , #{payTypeIdx}
			  , #{payTypeGroup}
			  , #{payType}
			  , #{brandOnlyYn}
			  , #{francIdx}
			  , #{regUser}
			  , now()
			  , #{regUser}
			  , now()
			)
	</insert>

	<select id="Franchisee_ListFrancPaymentType" parameterType="qss.vo.FranchiseeVo" resultType="qss.vo.BrandPaymentTypeVo">
	    /*
		  ID  : franchisee_sql.Franchisee_ListFrancPaymentType
		  DEC : 사이트기본 형태 조회
		*/
		SELECT DOMAIN_IDX
		     , BRAND_IDX
		     , PAY_TYPE_IDX
		     , PAY_TYPE
		     , BRAND_ONLY_YN
		     , FRANC_IDX
		     , PAY_TYPE_GROUP
		FROM   brand_payment_type B
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
		AND    BRAND_ONLY_YN = 'N'
	</select>

	<select id="Franchisee_ListFranchisee" parameterType="qss.vo.FranchiseeVo" resultType="qss.vo.FranchiseeVo">
		 /*
		  ID  : franchisee_sql.Franchisee_ListFranchisee
		  DEC : 사이트 리스트 조회
		*/
		    <include refid="Common.BeforeSQL"/>
		    <!-- 시스템 관라지 일경우 -->
			<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
			    SELECT F.DOMAIN_IDX
				     , F.BRAND_IDX
				     , F.FRANC_CODE
				     , F.FRANC_IDX
			         , F.FRANC_NAME
			         , IFNULL(F.CLOSED_DAY_INFO, '') AS CLOSED_DAY_INFO
			         , F.ALL_DAY_SALES_YN
			         , IFNULL(F.TEL_NUM, '') AS TEL_NUM
			         ,  concat
			            (
			              (
			                CASE
						    WHEN F.ALL_DAY_SALES_YN = 'Y'
						    THEN '(익일) '
						    ELSE ''
						    END
						  ),
					      substring(F.SALES_END_TIME,1,2),
					      ' : ',
					      substring(F.SALES_END_TIME,3,2)
					     ) as SALES_END_TIME
			         , concat(substring(F.SALES_START_TIME,1,2),' : ',substring(F.SALES_START_TIME,3,2)) as SALES_START_TIME
			         , F.ACTIVE_YN
			         , F.REG_DATE
			         , g.GROUP_NAME as groupName
			         , (SELECT COUNT(DEVICE_IDX) FROM kiosk WHERE ifnull(DEL_YN, 'N') = 'N' AND DOMAIN_IDX = F.DOMAIN_IDX AND BRAND_IDX = F.BRAND_IDX AND FRANC_IDX = F.FRANC_IDX GROUP BY DOMAIN_IDX,BRAND_IDX,FRANC_IDX) AS deviceCnt
				FROM   franchisee F
     				   INNER JOIN brand b ON  b.DOMAIN_IDX = F.DOMAIN_IDX AND b.BRAND_IDX = F.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
      				   INNER JOIN sitegroup g ON  g.DOMAIN_IDX = F.DOMAIN_IDX AND g.BRAND_IDX = F.BRAND_IDX AND g.GROUP_IDX = F.GROUP_IDX AND ifnull(g.DEL_YN, 'N') = 'N'
				WHERE  IFNULL(F.DEL_YN, 'N') = 'N'
				AND    F.DOMAIN_IDX = #{domainIdx}
				<if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
					AND F.BRAND_IDX = #{brandIdx}
				</if>
				<if test="groupIdx != null and groupIdx != '' and groupIdx != 0">
					AND F.GROUP_IDX = #{groupIdx}
				</if>
				<if test="francIdx != null and francIdx != '' and francIdx != 0">
					AND F.FRANC_IDX = #{francIdx}
				</if>
				<if test="sSearch != null and sSearch != ''">
		            AND F.FRANC_NAME LIKE CONCAT('%',#{sSearch},'%')
		        </if>
	        </if>

	        <!-- 시스템 관라지가 아닐경우(서비스, 매장 관리자) -->
			<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
				 SELECT F.DOMAIN_IDX
				     , F.BRAND_IDX
				     , F.FRANC_CODE
				     , F.FRANC_IDX
			         , F.FRANC_NAME
			         , F.CLOSED_DAY_INFO
			         , F.ALL_DAY_SALES_YN
			         , F.TEL_NUM
			         , concat(substring(F.SALES_START_TIME,1,2),' : ',substring(F.SALES_START_TIME,3,2)) as SALES_START_TIME
	             	 , concat(substring(F.SALES_END_TIME,1,2),' : ',substring(F.SALES_END_TIME,3,2)) as SALES_END_TIME
			         , F.ACTIVE_YN
			         , F.REG_DATE
			         , g.GROUP_NAME as groupName
			         , (SELECT COUNT(DEVICE_IDX) FROM kiosk WHERE ifnull(DEL_YN, 'N') = 'N' AND DOMAIN_IDX = F.DOMAIN_IDX AND BRAND_IDX = F.BRAND_IDX AND FRANC_IDX = F.FRANC_IDX GROUP BY DOMAIN_IDX,BRAND_IDX,FRANC_IDX) AS deviceCnt
				FROM   franchisee F
      				   INNER JOIN brand b ON  b.DOMAIN_IDX = F.DOMAIN_IDX AND b.BRAND_IDX = F.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
      				   INNER JOIN sitegroup g ON  g.DOMAIN_IDX = F.DOMAIN_IDX AND g.BRAND_IDX = F.BRAND_IDX AND g.GROUP_IDX = F.GROUP_IDX AND ifnull(g.DEL_YN, 'N') = 'N'
				WHERE  IFNULL(F.DEL_YN, 'N') = 'N'
				AND    F.DOMAIN_IDX = #{domainIdx}
				 <if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
				 	/* 서비스 관리자는 해당 서비스에 포함된 모든 매장 포함되게 또는 선택한 매장만 */
					AND F.BRAND_IDX = #{sessionBrandIdx}
					<if test="groupIdx != null and groupIdx != '' and groupIdx != 0">
						AND F.GROUP_IDX = #{groupIdx}
					</if>
					<if test="francIdx != null and francIdx != '' and francIdx != 0">
					AND F.FRANC_IDX = #{francIdx}
					</if>
				 </if>

				 <if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0003'">
				 	/* 매장 관리자는 자신이 속한 서비스의 자기 매장만 보이게 */
				 	AND F.BRAND_IDX = #{sessionBrandIdx}
					AND F.FRANC_IDX = #{sessionFrancIdx}
				 </if>
				<if test="sSearch != null and sSearch != ''">
		            AND F.FRANC_NAME LIKE CONCAT('%',#{sSearch},'%')
		        </if>
			</if>

	        <include refid="Common.AfterSQL"/>

	</select>

	<select id="Franchisee_ListCountFranchisee" parameterType="qss.vo.FranchiseeVo" resultType="int">
		/*
		  ID  : franchisee_sql.Franchisee_ListCountFranchisee
		  DEC : 사이트 리스트 카운터
		*/
		<!-- 시스템 관라지 일경우 -->
		<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
			 SELECT COUNT(F.DOMAIN_IDX)
			 FROM   franchisee F
      			    INNER JOIN brand b ON  b.DOMAIN_IDX = F.DOMAIN_IDX AND b.BRAND_IDX = F.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
			 WHERE  IFNULL(F.DEL_YN, 'N') = 'N'
			 AND    F.DOMAIN_IDX = #{domainIdx}
			 <if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
				AND F.BRAND_IDX = #{brandIdx}
			</if>
			<if test="groupIdx != null and groupIdx != '' and groupIdx != 0">
					AND F.GROUP_IDX = #{groupIdx}
				</if>
			<if test="francIdx != null and francIdx != '' and francIdx != 0">
				AND F.FRANC_IDX = #{francIdx}
			</if>
			 <if test="sSearch != null and sSearch != ''">
	            AND F.FRANC_NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>
         </if>

         <!-- 시스템 관라지가 아닐경우(서비스, 매장 관리자) -->
		<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
			SELECT COUNT(F.DOMAIN_IDX)
			 FROM   franchisee F
			 		INNER JOIN brand b ON  b.DOMAIN_IDX = F.DOMAIN_IDX AND b.BRAND_IDX = F.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
			 WHERE  IFNULL(F.DEL_YN, 'N') = 'N'
			 AND    F.DOMAIN_IDX = #{sessionDomainIdx}
			 /* 서비스 관리자는 해당 서비스에 포함된 모든 매장 포함되게 또는 선택한 매자만 */
			 <if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
				AND F.BRAND_IDX = #{sessionBrandIdx}
				<if test="groupIdx != null and groupIdx != '' and groupIdx != 0">
					AND F.GROUP_IDX = #{groupIdx}
				</if>
				<if test="francIdx != null and francIdx != '' and francIdx != 0">
				AND F.FRANC_IDX = #{francIdx}
				</if>
			 </if>

			 /* 매장 관리자는 자신이 속한 서비스의 자기 매장만 보이게 */
			 <if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0003'">
			 	AND F.BRAND_IDX = #{sessionBrandIdx}
				AND F.FRANC_IDX = #{sessionFrancIdx}
			 </if>
			 <if test="sSearch != null and sSearch != ''">
	            AND F.FRANC_NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>
		</if>

	</select>

	<insert id="Franchisee_InsertFranchisee" parameterType="qss.vo.FranchiseeVo" >
		/*
		  ID  : franchisee_sql.Franchisee_InsertFranchisee
		  DEC : 사이트 등록
		*/

		<selectKey resultType="String" keyProperty="returnFrancIdx" order="BEFORE">
			SELECT IFNULL(MAX(CONVERT(FRANC_IDX, UNSIGNED)) + 1, '30000000001')
			FROM   franchisee
			WHERE  DOMAIN_IDX = #{domainIdx}
			AND    BRAND_IDX = #{brandIdx}
	    </selectKey>
		INSERT INTO franchisee
		(
			  DOMAIN_IDX
			, BRAND_IDX
			, FRANC_IDX
			, GROUP_IDX
			, FRANC_CODE
			, FRANC_NAME
			, SAP_MS_CD
			, ACTIVE_YN
			, DEL_YN
			, REG_USER
			, REG_DATE
			, MOD_USER
			, MOD_DATE
		)
		VALUES
		(
			 #{domainIdx}
		   , #{brandIdx}
		   , #{returnFrancIdx}
		   , #{groupIdx}
		   , #{francCode}
		   , #{francName}
		   , #{sapMsCd}
		   , #{activeYn}
		   , 'N'
		   , #{regUser}
		   , now()
		   , #{regUser}
		   , now()
		 )
	</insert>

	<update id="Franchisee_DeleteFranchisee"  parameterType="qss.vo.FranchiseeVo" >
		/*
		  ID  : franchisee_sql.Franchisee_DeleteFranchisee
		  DEC : 사이트 삭제
		*/
		UPDATE franchisee
		SET    DEL_YN = 'Y'
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}

	</update>

	<select id="Franchisee_ViewFranchiseeDetail" parameterType="qss.vo.FranchiseeVo" resultType="qss.vo.FranchiseeVo">
		/*
		  ID  : franchisee_sql.Franchisee_ViewFranchiseeDetail
		  DEC : 사이트 상세 조회
		*/
		SELECT DOMAIN_IDX
		     , BRAND_IDX
		     , FRANC_IDX
		     , MAIN_IMG
		     , (
		     		SELECT THUMBNAIL_PATH
		     		FROM   file_content
		     		WHERE  FILE_CONTENT_IDX = F.MAIN_IMG
		     	) AS MAINIMG_PATH
	         , FRANC_ADDR
	         , FRANC_ADDR_DETAIL
			 , TEL_NUM
			 , SALES_START_TIME
			 , SALES_END_TIME
	         , ALL_DAY_SALES_YN
	         , TEL_NUM
	         , MEMO
	         , CLOSED_DAY_INFO
	         , CATEGORY_TYPE
	         , (SELECT CODE_NAME FROM system_code WHERE CODE_GROUP = 'CATE0000' AND CODE_VALUE = F.CATEGORY_TYPE AND IFNULL(DEL_YN, 'N') = 'N') AS CATEGORY_TYPE_NAME
		FROM   franchisee F
		WHERE  IFNULL(DEL_YN, 'N') = 'N'
		AND    DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
	</select>

	<update id="Franchisee_UpdateFranchiseeDetail" parameterType="qss.vo.FranchiseeVo"  >
		/*
		  ID  : franchisee_sql.Franchisee_UpdateFranchiseeDetail
		  DEC : 사이트 상세 저장
		*/
		UPDATE franchisee
		set    MOD_USER = #{regUser}
		     , MOD_DATE = now()
		     , MAIN_IMG = #{mainImg}
		     , FRANC_ADDR = #{francAddr}
		     , FRANC_ADDR_DETAIL = #{francAddrDetail}
		     , TEL_NUM = #{telNum}
		     , SALES_START_TIME = #{salesStartTime}
		     , SALES_END_TIME = #{salesEndTime}
		     , ALL_DAY_SALES_YN = #{allDaySalesYn}
		     , MEMO = #{memo}
		     , CATEGORY_TYPE = #{categoryType}
		     , CLOSED_DAY_INFO = #{closedDayInfo}
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
	</update>

	<update id="Franchisee_ActiveFranchisee" parameterType="qss.vo.FranchiseeVo">
		/*
		  ID  : franchisee_sql.Franchisee_ActiveFranchisee
		  DEC : 사이트  활성화 여부
		*/
		UPDATE franchisee
		set    MOD_USER = #{regUser}
		     , MOD_DATE = now()
		     , ACTIVE_YN = #{activeYn}
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
	</update>

	<select id="Franchisee_ListKiosk" parameterType="qss.vo.FranchiseeVo" resultType="qss.vo.FranchiseeVo">
		/*
		  ID  : franchisee_sql.Franchisee_ListKiosk
		  DEC : 사이트 단말 목록 조회
		*/
		<include refid="Common.BeforeSQL"/>
		SELECT DEVICE_IDX
			 , DEVICE_CODE
			 , DEVICE_NAME
			 , (
			 		SELECT CODE_NAME
			 		FROM   system_code
			 		WHERE  CODE_GROUP = 'DVC0000' AND  CODE_VALUE = K.DEVICE_TYPE
			 		AND    IFNULL(DEL_YN, 'N') = 'N'
			 	) AS DEVICE_TYPE
			 , ACTIVE_YN
			 , date_format(REG_DATE, '%Y-%m-%d') AS REG_DATE
			 , date_format(MOD_DATE, '%Y-%m-%d') AS MOD_DATE
		FROM  kiosk K
		WHERE IFNULL(DEL_YN, 'N') = 'N'
		AND   DOMAIN_IDX = #{domainIdx}
		AND   BRAND_IDX = #{brandIdx}
		AND   FRANC_IDX = #{francIdx}
		<if test="sSearch != null and sSearch != ''">
           AND DEVICE_NAME LIKE CONCAT('%',#{sSearch},'%')
        </if>
        <if test="sSortName == null or sSortName == ''">
<!--         ORDER BY REG_DATE -->
        </if>
        <include refid="Common.AfterSQL"/>

	</select>

	<select id="Franchisee_ListCountKiosk" parameterType="qss.vo.FranchiseeVo" resultType="int">
		/*
		  ID  : franchisee_sql.Franchisee_ListCountKiosk
		  DEC : 사이트 단말기 카운터
		*/
		 SELECT COUNT(*)
		 FROM   kiosk
		 WHERE IFNULL(DEL_YN, 'N') = 'N'
		 AND   DOMAIN_IDX = #{domainIdx}
		 AND   BRAND_IDX = #{brandIdx}
		 AND   FRANC_IDX = #{francIdx}
		 <if test="sSearch != null and sSearch != ''">
           AND DEVICE_NAME LIKE CONCAT('%',#{sSearch},'%')
         </if>
	</select>


	<insert id="Franchisee_InsertKiosk" parameterType="qss.vo.FranchiseeVo" >
		/*
		  ID  : franchisee_sql.Franchisee_InsertKiosk
		  DEC : 사이트 단말 저장
		*/
		<selectKey resultType="BigInteger" keyProperty="returnIdx" order="BEFORE">
	        SELECT IFNULL(MAX(DEVICE_IDX) + 1, '1')
			FROM   kiosk
	    </selectKey>
		INSERT INTO kiosk
		(
		    DOMAIN_IDX
		  , BRAND_IDX
		  , FRANC_IDX
		  , DEVICE_IDX
		  , DEVICE_CODE
		  , DEVICE_NAME
		  , DEVICE_TYPE
		  , DEVICE_RES_TYPE
		  , DEVICE_SITE_TYPE
		  , DEVICE_TRANS_TYPE
		  , COL_COUNT_TYPE
		  , ACTIVE_YN
		  , DEL_YN
		  , REG_USER
		  , REG_DATE
		  , MOD_USER
		  , MOD_DATE
		) VALUES (
		    #{domainIdx}
		  , #{brandIdx}
		  , #{francIdx}
		  , #{returnIdx}
		  , #{deviceCode}
		  , #{deviceName}
		  , #{deviceType}
		  , #{deviceResType}
		  , #{deviceSiteType}
		  , #{deviceTransType}
		  , #{colCountType}
		  , #{activeYn}
		  , 'N'
		  , #{regUser}
		  , now()
		  , #{regUser}
		  , now()
		)
	</insert>

	<select id="Franchisee_ViewKiosk" parameterType="qss.vo.FranchiseeVo" resultType="qss.vo.FranchiseeVo">
		/*
		  ID  : franchisee_sql.Franchisee_ViewKiosk
		  DEC : 사이트 단말 상세 조회
		*/
		SELECT DEVICE_IDX
			 , DEVICE_CODE
			 , DEVICE_NAME
			 , DEVICE_TYPE
			 , DEVICE_RES_TYPE AS deviceResType
			 , DEVICE_SITE_TYPE AS deviceSiteType
			 , DEVICE_TRANS_TYPE AS deviceTransType
			 , COL_COUNT_TYPE
			 , ACTIVE_YN
			 , DOMAIN_IDX
			 , BRAND_IDX
			 , FRANC_IDX
		FROM  kiosk
		WHERE IFNULL(DEL_YN, 'N') = 'N'
		AND   DOMAIN_IDX = #{domainIdx}
		AND   BRAND_IDX = #{brandIdx}
		AND   FRANC_IDX = #{francIdx}
		AND   DEVICE_IDX = #{deviceIdx}
	</select>

	<update id="Franchisee_UpdateKiosk" parameterType="qss.vo.FranchiseeVo">
		/*
		  ID  : franchisee_sql.Franchisee_UpdateKiosk
		  DEC : 사이트 단말 상세 수정
		*/
		UPDATE kiosk
		set    MOD_USER = #{regUser}
		     , MOD_DATE = now()
		     , DEVICE_CODE = #{deviceCode}
		     , DEVICE_NAME = #{deviceName}
		     , DEVICE_TYPE = #{deviceType}
		     , DEVICE_RES_TYPE = #{deviceResType}
			 , DEVICE_SITE_TYPE = #{deviceSiteType}
			 , DEVICE_TRANS_TYPE = #{deviceTransType}
		     , COL_COUNT_TYPE = #{colCountType}
		     , ACTIVE_YN = #{activeYn}
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
		AND    DEVICE_IDX = #{deviceIdx}
	</update>

	<update id="Franchisee_DeleteKiosk" parameterType="qss.vo.FranchiseeVo">
		/*
		  ID  : franchisee_sql.Franchisee_DeleteKiosk
		  DEC : 사이트 단말 삭제
		*/
		UPDATE kiosk
		set    DEL_YN = 'Y'
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
		AND    DEVICE_IDX IN
		<foreach collection="checkboxArr" item="deviceIdx" open="(" close=")" separator=",">
	        #{deviceIdx}
	    </foreach>
	</update>

	<update id="Franchisee_ActiveKiosk" parameterType="qss.vo.FranchiseeVo">
		/*
		  ID  : franchisee_sql.Franchisee_KioskActive
		  DEC : 단말기  활성화 여부
		*/
		UPDATE kiosk
		set    MOD_USER = #{regUser}
		     , MOD_DATE = now()
		     , ACTIVE_YN = #{activeYn}
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
		AND    DEVICE_IDX = #{deviceIdx}
	</update>

	<select id="Franchisee_OverlapCountFranchisee" parameterType="qss.vo.FranchiseeVo" resultType="int">
		/*
		  ID  : franchisee_sql.Franchisee_OverlapCountFranchisee
		  DEC : 사이트 코드 중복체크
		*/
		SELECT  count(*)
		FROM    franchisee
		WHERE   IFNULL(DEL_YN, 'N') = 'N'
		AND     DOMAIN_IDX = #{domainIdx}
		AND     FRANC_CODE = #{francCode}
		<if test="francIdx != null and francIdx != '' and francIdx != 0">
			AND !(BRAND_IDX = #{brandIdx} AND FRANC_IDX = #{francIdx})
		</if>
	</select>

	<select id="Franchisee_OverlapCountKiosk" parameterType="qss.vo.FranchiseeVo" resultType="int">
		/*
		  ID  : franchisee_sql.Franchisee_OverlapCountKiosk
		  DEC : 단말 코드 중복체크
		*/
		SELECT  count(*)
		FROM    kiosk
		WHERE   IFNULL(DEL_YN, 'N') = 'N'
		AND     DOMAIN_IDX = #{domainIdx}
		AND     DEVICE_CODE = #{deviceCode}
		<if test="deviceIdx != null and deviceIdx != '' and deviceIdx != 0">
			AND !(BRAND_IDX = #{brandIdx} AND FRANC_IDX = #{francIdx} AND DEVICE_IDX = #{deviceIdx})
		</if>
	</select>

	<insert id="Franchisee_InsertFrancScheduleVersion" parameterType="qss.vo.FranchiseeVo">
		/*
		  ID  : franchisee_sql.Franchisee_InsertFrancScheduleVersion
		  DEC : 사이트 기준 스케줄버전 추가
		*/
		INSERT INTO schedule_version
		(
		  DEVICE_CODE
		 ,SCHEDULE_VERSION_IDX
		 ,SCHEDULE_TYPE
		 ,MOD_REASON
		 ,REG_USER
		 ,REG_DATE
		 ,MOD_USER
		 ,MOD_DATE
		)
		SELECT DEVICE_CODE
		      ,(
		      		SELECT IFNULL(MAX(SCHEDULE_VERSION_IDX) + 1, 1)
		      		FROM   schedule_version
		      		WHERE  DEVICE_CODE = K.DEVICE_CODE
<!-- 		      		AND    SCHEDULE_TYPE = #{scheduleType} -->
		      	) AS SCHEDULE_VERSION_IDX
		      ,#{scheduleType} AS SCHEDULE_TYPE
		      ,(
		      		SELECT CODE_NAME
		      		FROM   system_code
		      		WHERE  CODE_GROUP = 'SCH0000' AND  CODE_VALUE = #{scheduleType}
		      		AND    IFNULL(DEL_YN, 'N') = 'N'
		      	) AS MOD_REASON
		      ,#{regUser} AS REG_USER
		      ,now() AS REG_DATE
		      ,#{regUser} AS MOD_USER
		      ,now() AS MOD_DATE
		FROM   kiosk K
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
		AND    IFNULL(K.DEL_YN, 'N') = 'N'
	</insert>

	<insert id="Franchisee_InsertDeviceScheduleVersion" parameterType="qss.vo.FranchiseeVo">
		/*
		  ID  : franchisee_sql.Franchisee_InsertFrancScheduleVersion
		  DEC : 단말 기준 스케줄버전 추가
		  USAGE : 사이트 관리 > 단말기 저장/수정/삭제
		*/
		INSERT INTO schedule_version
		(
		  DEVICE_CODE
		 ,SCHEDULE_VERSION_IDX
		 ,SCHEDULE_TYPE
		 ,MOD_REASON
		 ,REG_USER
		 ,REG_DATE
		 ,MOD_USER
		 ,MOD_DATE
		)
		SELECT
		  A.DEVICE_CODE,
		  A.SCHEDULE_VERSION_IDX,
		  A.SCHEDULE_TYPE,
		  A.MOD_REASON,
		  A.REG_USER,
		  A.REG_DATE,
		  A.REG_USER,
		  A.MOD_DATE
		FROM
		  (
			SELECT DEVICE_CODE
		      ,(
		      		SELECT IFNULL(MAX(SCHEDULE_VERSION_IDX) + 1, 1)
		      		FROM   schedule_version
		      		WHERE  DEVICE_CODE = K.DEVICE_CODE
<!-- 		      		AND    SCHEDULE_TYPE = #{scheduleType} -->
		      	) AS SCHEDULE_VERSION_IDX
		      ,#{scheduleType} AS SCHEDULE_TYPE
		      ,(
		      		SELECT CODE_NAME
		      		FROM   system_code
		      		WHERE  CODE_GROUP = 'SCH0000' AND  CODE_VALUE = #{scheduleType}
		      		AND    IFNULL(DEL_YN, 'N') = 'N'
		      	) AS MOD_REASON
		      ,#{regUser} AS REG_USER
		      ,now() AS REG_DATE
		      ,#{regUser} AS MOD_USER
		      ,now() AS MOD_DATE
		FROM   kiosk K
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
		AND    IFNULL(K.DEL_YN, 'N') = 'N'
		AND    DEVICE_IDX IN
		<foreach collection="checkboxArr" item="deviceIdx" open="(" close=")" separator=",">
	        #{deviceIdx}
	    </foreach>
	    ) A
     GROUP BY  A.DEVICE_CODE,
              A.SCHEDULE_VERSION_IDX,
              A.SCHEDULE_TYPE,
              A.MOD_REASON,
              A.REG_USER,
              A.REG_DATE,
              A.REG_USER,
              A.MOD_DATE
	</insert>

    <!-- 사이트 콤보박스 조회 -->
	<select id="Franchisee_SelectCombo" parameterType="qss.vo.FranchiseeVo" resultType="qss.vo.FranchiseeVo">
		/*
		  ID  : franchisee_sql.Franchisee_SelectCombo
		  DEC : 사이트 콤보박스 조회
		*/
		SELECT DOMAIN_IDX
		     , BRAND_IDX
		     , FRANC_IDX
		     , FRANC_NAME
		FROM   franchisee F
		WHERE  IFNULL(DEL_YN, 'N') = 'N'
		AND    DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
   	  ORDER BY FRANC_IDX
	</select>

	<insert id="Franchisee_InsertFranchiseeGroup" parameterType="qss.vo.FranchiseeVo">
		<selectKey resultType="String" keyProperty="returnGroupIdx" order="BEFORE">
			SELECT IFNULL(MAX(CONVERT(GROUP_IDX, UNSIGNED)) + 1, '40000000001')
			FROM   sitegroup
	    </selectKey>
		INSERT INTO sitegroup(GROUP_IDX, DOMAIN_IDX, BRAND_IDX, PARENT_GROUP_IDX, GROUP_NAME, GROUP_DEPTH, ACTIVE_YN, REG_USER, REG_DATE, MOD_USER, MOD_DATE, DEL_YN)
		VALUES(
				#{returnGroupIdx},
				#{domainIdx},
				#{brandIdx},
				#{groupIdx},
				#{groupName},
				#{groupDepth},
				'Y',
				#{regUser},
				now(),
				#{regUser},
				now(),
				'N'
				)
	</insert>
	
	<select id="Franchisee_GetGroupDepth" parameterType="qss.vo.FranchiseeVo" resultType="Integer">
		/*
		  ID  : franchisee_sql.Franchisee_GetGroupDepth
		  DEC : 그룹 Depth 조회
		*/
		SELECT MAX(GROUP_DEPTH) + 1
		FROM   sitegroup
		WHERE  IFNULL(DEL_YN, 'N') = 'N'
				AND DOMAIN_IDX = #{domainIdx}
				AND BRAND_IDX = #{brandIdx}
				AND GROUP_IDX = #{groupIdx}
	</select>
	
	<update id="Franchisee_DeleteGroup"  parameterType="qss.vo.FranchiseeVo" >
		/*
		  ID  : franchisee_sql.Franchisee_DeleteGroup
		  DEC : 그룹 삭제
		*/
		UPDATE sitegroup
		SET    DEL_YN = 'Y'
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    GROUP_IDX IN
		<foreach collection="strArr" item="gIdx"  open="(" close=")" separator=",">
            #{gIdx}
        </foreach>

	</update>
	
	
	<select id="Franchisee_SiteGroupGet" parameterType="qss.vo.FranchiseeVo" resultType="qss.vo.FranchiseeVo">
	    /*
		  ID  : franchisee_sql.Franchisee_SiteGroupGet
		  DEC : 사이트그룹 조회
		*/
		SELECT DOMAIN_IDX
		     , BRAND_IDX
		     , PARENT_GROUP_IDX
		     , (SELECT GROUP_NAME FROM sitegroup WHERE GROUP_IDX = A.PARENT_GROUP_IDX) AS parentName
		     , GROUP_IDX
		     , GROUP_NAME
		FROM   sitegroup A
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    GROUP_IDX = #{groupIdx} 
	</select>
	
	
	<update id="Franchisee_UpdateFranchiseeGroup"  parameterType="qss.vo.FranchiseeVo" >
		/*
		  ID  : franchisee_sql.Franchisee_UpdateFranchiseeGroup
		  DEC : 그룹 수정
		*/
		UPDATE sitegroup
		SET    PARENT_GROUP_IDX = #{parentGroupIdx}
			 , GROUP_NAME = #{groupName}
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    GROUP_IDX = #{realGroupIdx}

	</update>
</mapper>