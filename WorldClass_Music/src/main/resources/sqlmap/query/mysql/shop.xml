<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Shop">
	
	<insert id="Shop_Create" parameterType="qss.vo.ShopVo" useGeneratedKeys="true">
		<selectKey keyProperty="newIdx" resultType="biginteger" order="BEFORE">
			SELECT IFNULL(MAX(SHOP_IDX) + 1, 1)
			FROM SHOP
		</selectKey>
		INSERT INTO SHOP(DOMAIN_IDX, BRAND_IDX, SHOP_IDX, DISP_NM_KR, DISP_NM_EN, TEL_NUM, LOGO_IMG, DETAIL_IMG, DETAIL_DISP_YN, DETAIL_CONCEPT_TXT, DETAIL_CONCEPT_TXT_EN, ACTIVE_YN, DEL_YN, REG_USER, REG_DATE, MOD_USER, MOD_DATE)
				  VALUES(#{domainIdx},
				  		 #{brandIdx},
				  		 #{newIdx},
				  		 #{dispNmKr},
				  		 #{dispNmEn},
				  		 #{telNum},
				  		 #{logoImg},
				  		 #{detailImg},
				  		 #{detailDispYn},
				  		 #{detailConceptTxt},
				  		 #{detailConceptTxtEn},
				  		 'Y',
				  		 'N',
				  		 #{regUser},
				  		 NOW(),
				  		 #{modUser},
				  		 NOW()
				  		 )
	</insert>
	
	<insert id="Shop_ImageListCreate" parameterType="qss.vo.ShopVo">
		INSERT INTO SHOP_IMAGELIST (DOMAIN_IDX, BRAND_IDX, SHOP_IDX, FILE_CONTENT_IDX, ORDER_SEQ, DETAIL_MENU_TITLE, DETAIL_MENU_DESC, DETAIL_MENU_TITLE_EN, DETAIL_MENU_DESC_EN)
		VALUES
		<foreach item="item" index="index" collection="detailMenuList" separator=" , ">
			(#{item.domainIdx},#{item.brandIdx}, #{shopIdx}, #{item.fileContentIdx}, #{item.orderSeq}, #{item.detailMenuTitle}, #{item.detailMenuDesc}, #{item.detailMenuTitleEn}, #{item.detailMenuDescEn})
		</foreach>
	</insert>
	
	<delete id="Shop_ImageListDelete" parameterType="qss.vo.ShopVo">
		DELETE
		FROM	SHOP_IMAGELIST
		WHERE	SHOP_IDX = (#{shopIdx})
	</delete>
	
	<select id="Shop_Get" parameterType="qss.vo.ShopVo" resultType="qss.vo.ShopVo">
		SELECT	A.DOMAIN_IDX,
				A.BRAND_IDX,
		        A.SHOP_IDX,
		        A.DISP_NM_KR,
		        A.DISP_NM_EN,
		        A.DISP_NM_CH,
		        A.DISP_NM_JP,
		        A.TEL_NUM,
		        A.LOGO_IMG,
				B.THUMBNAIL_PATH AS LOGO_THUMBNAIL_PATH,
		        A.DETAIL_DISP_YN,
		        A.DETAIL_CONCEPT_TXT,
		        A.DETAIL_CONCEPT_TXT_EN,
		        A.DETAIL_IMG,
		        C.THUMBNAIL_PATH AS DETAIL_THUMBNAIL_PATH
		FROM	SHOP A
		LEFT OUTER JOIN FILE_CONTENT B ON A.LOGO_IMG = B.FILE_CONTENT_IDX
		LEFT OUTER JOIN FILE_CONTENT C ON A.DETAIL_IMG = C.FILE_CONTENT_IDX
		WHERE	A.DEL_YN = 'N'
				AND A.DOMAIN_IDX = #{domainIdx}
				AND A.BRAND_IDX = #{brandIdx}
				AND A.SHOP_IDX = #{shopIdx}
	</select>
	
	<select id="Shop_ImageListList" parameterType="qss.vo.ShopVo" resultType="qss.vo.ShopVo">
		SELECT A.FILE_CONTENT_IDX, B.THUMBNAIL_PATH, A.SHOP_IDX, A.DETAIL_MENU_TITLE, A.DETAIL_MENU_DESC, A.DETAIL_MENU_TITLE_EN, A.DETAIL_MENU_DESC_EN
		FROM 	SHOP_IMAGELIST A
			INNER JOIN FILE_CONTENT B ON A.FILE_CONTENT_IDX = B.FILE_CONTENT_IDX
		WHERE	A.SHOP_IDX = #{shopIdx}
				AND A.DOMAIN_IDX = #{domainIdx}
				AND A.BRAND_IDX = #{brandIdx}
		ORDER BY ORDER_SEQ
	</select>
	
	<update id="Shop_Delete" parameterType="qss.vo.ShopVo">
		<![CDATA[
			UPDATE  SHOP
		    SET     DEL_YN = 'Y',
		            MOD_USER = #{modUser},
		            MOD_DATE = NOW()
		    WHERE   DOMAIN_IDX = #{domainIdx} AND BRAND_IDX = #{brandIdx}
		]]>
		AND SHOP_IDX IN
		<foreach collection="checkboxArr" item="item"  open="(" close=")" separator=",">
            #{item}
        </foreach>
	</update>
	
	<update id="Shop_Update" parameterType="qss.vo.ShopVo">
		UPDATE	SHOP
		SET		DISP_NM_KR = #{dispNmKr}, 
				DISP_NM_EN = #{dispNmEn},
				TEL_NUM = #{telNum},
				LOGO_IMG = #{logoImg},
				DETAIL_IMG = #{detailImg},
				DETAIL_DISP_YN = #{detailDispYn},
				DETAIL_CONCEPT_TXT = #{detailConceptTxt},
				DETAIL_CONCEPT_TXT_EN = #{detailConceptTxtEn},
				MOD_USER = #{modUser},
				MOD_DATE = NOW()
		WHERE	SHOP_IDX = #{shopIdx}
	</update>
	
	<select id="Shop_List" parameterType="qss.vo.ShopVo" resultType="qss.vo.ShopVo">
		<include refid="Common.BeforeSQL" />
		SELECT	*
		FROM	(
				SELECT	A.DOMAIN_IDX,
						A.BRAND_IDX,
						A.SHOP_IDX,
						B.THUMBNAIL_PATH AS LOGO_THUMBNAIL_PATH,
						REPLACE(A.DISP_NM_KR, '\\n', '') AS DISP_NM_KR,
						REPLACE(A.DISP_NM_EN, '\\n', '') AS DISP_NM_EN,
						D.DISP_SHORT_NM AS FLOOR_NM,
						A.TEL_NUM,
						A.ACTIVE_YN,
						A.DETAIL_DISP_YN,
						DATE_FORMAT(A.MOD_DATE,'%Y-%m-%d') AS MOD_DATE,
						A.DEL_YN
				FROM	SHOP A
				LEFT OUTER JOIN FILE_CONTENT B ON A.LOGO_IMG = B.FILE_CONTENT_IDX
				LEFT OUTER JOIN FLOOR_SHOP C ON A.DOMAIN_IDX = C.DOMAIN_IDX AND A.BRAND_IDX = C.BRAND_IDX AND A.SHOP_IDX = C.SHOP_IDX
				LEFT OUTER JOIN FLOOR D ON D.DOMAIN_IDX = C.DOMAIN_IDX AND D.BRAND_IDX = C.BRAND_IDX AND D.FLOOR_IDX = C.FLOOR_IDX AND D.DEL_YN = 'N'
				WHERE	A.DEL_YN = 'N'
						AND A.DOMAIN_IDX = #{domainIdx}
						AND A.BRAND_IDX = #{brandIdx}
		) A
		WHERE A.DEL_YN = 'N'
		<if test="sSearch != null and sSearch != ''">
			AND (REPLACE(A.DISP_NM_KR, ' ', '') LIKE CONCAT('%',#{sSearch},'%') OR
				 REPLACE(A.DISP_NM_EN, ' ', '') LIKE CONCAT('%',#{sSearch},'%')
				 )
		</if>
		<if test="floorNm != null and floorNm != ''">
			AND A.FLOOR_NM = #{floorNm}
		</if>
		<include refid="Common.AfterSQL" />
	</select>
	
	<select id="Shop_ListCnt" parameterType="qss.vo.ShopVo" resultType="int">
		SELECT	COUNT(*)
		FROM	(
				SELECT	REPLACE(A.DISP_NM_KR, '\\n', '') AS DISP_NM_KR,
						REPLACE(A.DISP_NM_EN, '\\n', '') AS DISP_NM_EN,
						D.DISP_SHORT_NM AS FLOOR_NM,
						A.DEL_YN
				FROM	SHOP A
				LEFT OUTER JOIN FILE_CONTENT B ON A.LOGO_IMG = B.FILE_CONTENT_IDX
				LEFT OUTER JOIN FLOOR_SHOP C ON A.DOMAIN_IDX = C.DOMAIN_IDX AND A.BRAND_IDX = C.BRAND_IDX AND A.SHOP_IDX = C.SHOP_IDX
				LEFT OUTER JOIN FLOOR D ON D.DOMAIN_IDX = C.DOMAIN_IDX AND D.BRAND_IDX = C.BRAND_IDX AND D.FLOOR_IDX = C.FLOOR_IDX AND D.DEL_YN = 'N'
				WHERE	A.DEL_YN = 'N'
						AND A.DOMAIN_IDX = #{domainIdx}
						AND A.BRAND_IDX = #{brandIdx}
		) A
		WHERE	A.DEL_YN = 'N'
		<if test="sSearch != null and sSearch != ''">
			AND (REPLACE(A.DISP_NM_KR, ' ', '') LIKE CONCAT('%',#{sSearch},'%') OR
				 REPLACE(A.DISP_NM_EN, ' ', '') LIKE CONCAT('%',#{sSearch},'%')
				 )
		</if>
		<if test="floorNm != null and floorNm != ''">
			AND A.FLOOR_NM = #{floorNm}
		</if>
	</select>
	
	<select id="Shop_FloorNmList" parameterType="qss.vo.ShopVo" resultType="qss.vo.ShopVo">
		SELECT	DISP_SHORT_NM AS FLOOR_NM
		FROM	FLOOR
		WHERE	DOMAIN_IDX = #{domainIdx}
				AND BRAND_IDX = #{brandIdx}
				AND DEL_YN = 'N'
		ORDER BY ORDER_SEQ
	</select>
	
	<update id="Shop_ActiveYn" parameterType="qss.vo.ShopVo">
		UPDATE  SHOP
	    SET     ACTIVE_YN = #{activeYn},
	            MOD_USER = #{modUser},
	            MOD_DATE = NOW()
	    WHERE   DOMAIN_IDX = #{domainIdx} AND BRAND_IDX = #{brandIdx} AND SHOP_IDX = #{shopIdx}
	</update>
</mapper>	