<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="OptionProd">

	<select id="OptionProd_ListCountOptionProd" parameterType="hashmap" resultType="int">
		/*
		  ID  : OptionProd_sql.OptionProd_ListCountOptionProd
		  DEC : 상품 count 조회
		*/
		<!-- 시스템 관라지 일경우 -->
		<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
			SELECT COUNT(OP.DOMAIN_IDX) AS CNT
			FROM   OPTION_PROD OP
				   INNER JOIN franchisee f ON  f.DOMAIN_IDX = OP.DOMAIN_IDX AND f.BRAND_IDX = OP.BRAND_IDX AND f.FRANC_IDX = OP.FRANC_IDX AND ifnull(f.DEL_YN, 'N') = 'N'
      			   INNER JOIN brand b ON  b.DOMAIN_IDX = OP.DOMAIN_IDX AND b.BRAND_IDX = OP.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
			WHERE  IFNULL(OP.DEL_YN, 'N') = 'N'
			AND    OP.DOMAIN_IDX = #{domainIdx}
			<!-- 루트 조회 필요 -->
			<if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
				AND OP.BRAND_IDX = #{brandIdx}
			</if>
			<if test="francIdx != null and francIdx != '' and francIdx != 0">
				AND OP.FRANC_IDX = #{francIdx}
			</if>
			<if test="sSearch != null and sSearch != ''">
	            AND OP.OPTION_PROD_DISPLAY_NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>
	     </if>
	     <!-- 시스템 관라지가 아닐경우(브랜드, 매장 관리자) -->
		 <if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
		 	SELECT COUNT(OP.DOMAIN_IDX) AS CNT
			FROM   OPTION_PROD OP
				   INNER JOIN franchisee f ON  f.DOMAIN_IDX = OP.DOMAIN_IDX AND f.BRAND_IDX = OP.BRAND_IDX AND f.FRANC_IDX = OP.FRANC_IDX AND ifnull(f.DEL_YN, 'N') = 'N'
      			   INNER JOIN brand b ON  b.DOMAIN_IDX = OP.DOMAIN_IDX AND b.BRAND_IDX = OP.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
			WHERE  IFNULL(OP.DEL_YN, 'N') = 'N'
			AND    OP.DOMAIN_IDX = #{domainIdx}
			/* 브랜드 관리자는 해당 브랜드에 포함된 모든 매장 포함되게 또는 선택한 매자만 */
			<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
				AND OP.BRAND_IDX = #{sessionBrandIdx}
			</if>
			<if test="francIdx != null and francIdx != '' and francIdx != 0">
				AND OP.FRANC_IDX = #{francIdx}
			</if>

			/* 매장 관리자는 자신이 속한 브랜드의 자기 매장만 보이게 */
			<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0003'">
				AND OP.BRAND_IDX = #{sessionBrandIdx}
				AND OP.FRANC_IDX = #{sessionFrancIdx}
			</if>
			<if test="sSearch != null and sSearch != ''">
	            AND OP.OPTION_PROD_DISPLAY_NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>
		 </if>
	</select>

	<!-- 상품 리스트 조회 -->
	<select id="OptionProd_ListOptionProd" parameterType="qss.vo.OptionProdVo" resultType="qss.vo.OptionProdVo">
		/*
		  ID  : OptionProd_sql.OptionProd_ListOptionProd
		  DEC : 상품 리스트 조회
		*/
		<include refid="Common.BeforeSQL"/>
		<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
			SELECT
				  OP.DOMAIN_IDX			/*도메인일련번호*/
				,OP.BRAND_IDX				/*브랜드일련번호*/
				,OP.FRANC_IDX				/*가맹점일련번호*/
				,OP.OPTION_PROD_IDX			/*옵션 상품 일련번호*/
				,OP.OPTION_PROD_NAME				/*상품명*/
				,OP.OPTION_PROD_DISPLAY_NAME		/*상품 표시명*/
				,OP.OPTION_PROD_EN_NAME			/*상품 영문명*/
				,FORMAT(OP.OPTION_PROD_AMOUNT,0) as OPTION_PROD_AMOUNT	/*상품 가격*/
				,FORMAT(OP.OPTION_PROD_DISCOUNT_AMOUNT,0) as OPTION_PROD_DISCOUNT_AMOUNT	/*상품 할인 가격*/
				, date_format(OP.MOD_DATE, '%Y-%m-%d') AS MOD_DATE
				,OP.ACTIVE_YN
			FROM  OPTION_PROD OP
				  INNER JOIN franchisee f ON  f.DOMAIN_IDX = OP.DOMAIN_IDX AND f.BRAND_IDX = OP.BRAND_IDX AND f.FRANC_IDX = OP.FRANC_IDX AND ifnull(f.DEL_YN, 'N') = 'N'
      			  INNER JOIN brand b ON  b.DOMAIN_IDX = OP.DOMAIN_IDX AND b.BRAND_IDX = OP.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
			WHERE IFNULL(OP.DEL_YN, 'N') = 'N'
			<if test="activeYn != null and activeYn != ''">
	           AND    ifnull(OP.ACTIVE_YN, 'Y') = 'Y'
	        </if>
			AND   OP.DOMAIN_IDX = #{domainIdx}
			<!-- 루트 조회 필요 -->
			<if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
				AND OP.BRAND_IDX = #{brandIdx}
			</if>
			<if test="francIdx != null and francIdx != '' and francIdx != 0">
				AND OP.FRANC_IDX = #{francIdx}
			</if>
			<if test="sSearch != null and sSearch != ''">
	            AND OP.OPTION_PROD_DISPLAY_NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>
         </if>
         <!-- 시스템 관라지가 아닐경우(브랜드, 매장 관리자) -->
		 <if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
			SELECT
				  OP.DOMAIN_IDX			/*도메인일련번호*/
				,OP.BRAND_IDX				/*브랜드일련번호*/
				,OP.FRANC_IDX				/*가맹점일련번호*/
				,OP.OPTION_PROD_IDX			/*옵션 상품 일련번호*/
				,OP.OPTION_PROD_NAME				/*상품명*/
				,OP.OPTION_PROD_DISPLAY_NAME		/*상품 표시명*/
				,OP.OPTION_PROD_EN_NAME			/*상품 영문명*/
				,FORMAT(OP.OPTION_PROD_AMOUNT,0) as OPTION_PROD_AMOUNT	/*상품 가격*/
				,FORMAT(OP.OPTION_PROD_DISCOUNT_AMOUNT,0) as OPTION_PROD_DISCOUNT_AMOUNT	/*상품 할인 가격*/
				, date_format(OP.MOD_DATE, '%Y-%m-%d') AS MOD_DATE
				,OP.ACTIVE_YN
			FROM  OPTION_PROD OP
				  INNER JOIN franchisee f ON  f.DOMAIN_IDX = OP.DOMAIN_IDX AND f.BRAND_IDX = OP.BRAND_IDX AND f.FRANC_IDX = OP.FRANC_IDX AND ifnull(f.DEL_YN, 'N') = 'N'
      			  INNER JOIN brand b ON  b.DOMAIN_IDX = OP.DOMAIN_IDX AND b.BRAND_IDX = OP.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
			WHERE IFNULL(OP.DEL_YN, 'N') = 'N'
			AND   OP.DOMAIN_IDX = #{domainIdx}
			<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
			 	/* 브랜드 관리자는 해당 브랜드에 포함된 모든 매장 포함되게 또는 선택한 매장만 */
				AND OP.BRAND_IDX = #{sessionBrandIdx}
				<if test="francIdx != null and francIdx != '' and francIdx != 0">
				AND OP.FRANC_IDX = #{francIdx}
				</if>
			 </if>

			 <if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0003'">
			 	/* 매장 관리자는 자신이 속한 브랜드의 자기 매장만 보이게 */
			 	AND OP.BRAND_IDX = #{sessionBrandIdx}
				AND OP.FRANC_IDX = #{sessionFrancIdx}
			 </if>
			 <if test="sSearch != null and sSearch != ''">
	            AND OP.OPTION_PROD_DISPLAY_NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>

		 </if>
		 <if test="sSortName == null or sSortName == ''">
<!-- 		 ORDER BY OP.MOD_DATE -->
		 </if>
        <include refid="Common.AfterSQL"/>
	</select>

	<select id="OptionProd_ViewOptionProd" parameterType="qss.vo.OptionProdVo" resultType="qss.vo.OptionProdVo">
		/*
		  ID  : OptionProd_sql.OptionProd_ViewOptionProd
		  DEC : 상품 상세 조회
		*/
		SELECT BRAND_IDX				/*브랜드일련번호*/
			 , FRANC_IDX				/*가맹점일련번호*/
			 , OPTION_PROD_IDX			/*주문 상품 일련번호*/
			 , OPTION_PROD_CODE			/*옵션 상품 코드 */
			 , OPTION_PROD_NAME			/*상품명*/
			 , OPTION_PROD_DISPLAY_NAME	/*상품 표시명*/
			 , OPTION_PROD_EN_NAME		/*상품 영문명*/
			 , FORMAT(OPTION_PROD_AMOUNT,0) as OPTION_PROD_AMOUNT			/*상품 가격*/
			 , FORMAT(OPTION_PROD_DISCOUNT_AMOUNT,0) AS OPTION_PROD_DISCOUNT_AMOUNT	/*상품 할인 가격*/
			 , ACTIVE_YN
		FROM   OPTION_PROD OP
		WHERE  IFNULL(DEL_YN, 'N') = 'N'
		AND    DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
		AND    OPTION_PROD_IDX = #{optionProdIdx}
    </select>
	
	<update id="OptionProd_InsertOptionProd" parameterType="qss.vo.OptionProdVo">
		/*
		  ID  : Optionprod_sql.OptionProd_InsertOptionProd
		  DEC : 옵션 상품 저장
		*/
		<selectKey keyProperty="returnIdx" resultType="biginteger" order="BEFORE">
			SELECT IFNULL(MAX(OPTION_PROD_IDX) + 1, '1')
			FROM   OPTION_PROD
			WHERE  DOMAIN_IDX = #{domainIdx}
			AND    BRAND_IDX = #{brandIdx}
			AND    FRANC_IDX = #{francIdx}
		</selectKey>
		INSERT INTO OPTION_PROD (
		   DOMAIN_IDX
		  ,BRAND_IDX
		  ,FRANC_IDX
		  ,OPTION_PROD_IDX
		  ,OPTION_PROD_CODE
		  ,OPTION_PROD_NAME
		  ,OPTION_PROD_DISPLAY_NAME
		  ,OPTION_PROD_EN_NAME
		  ,OPTION_PROD_AMOUNT
		  ,REG_USER
		  ,REG_DATE
		  ,MOD_USER
		  ,MOD_DATE
		  ,OPTION_PROD_DISCOUNT_AMOUNT
		  ,DEL_YN
		  ,ACTIVE_YN
		) VALUES (
		   #{domainIdx}
		  ,#{brandIdx}
		  ,#{francIdx}
		  ,#{returnIdx}
		  ,#{optionProdCode}
		  ,#{optionProdName}
		  ,#{optionProdDisplayName}
		  ,#{optionProdEnName}
		  ,#{optionProdAmount}
		  , #{regUser}
		  , now()
		  , #{regUser}
		  , now()
		  ,#{optionProdDiscountAmount}
		  ,'N'
		  ,#{activeYn}
		)
	</update>

	<update id="OptionProd_UpdateOptionProd" parameterType="qss.vo.OptionProdVo">
		/*
		  ID  : OptionProd_sql.OptionProd_UpdateOptionProd
		  DEC : 옵션 상품 수정
		*/
		UPDATE OPTION_PROD
		SET     OPTION_PROD_CODE = #{optionProdCode}
		      , OPTION_PROD_NAME = #{optionProdName}
			  , OPTION_PROD_DISPLAY_NAME = #{optionProdDisplayName}
			  , OPTION_PROD_EN_NAME = #{optionProdEnName}
			  , OPTION_PROD_AMOUNT = #{optionProdAmount}
			  , MOD_USER = #{regUser}
			  , MOD_DATE = now()
			  , OPTION_PROD_DISCOUNT_AMOUNT = #{optionProdDiscountAmount}
			  , ACTIVE_YN = #{activeYn}
		WHERE   DOMAIN_IDX = #{domainIdx}
		  AND   BRAND_IDX = #{brandIdx}
		  AND   FRANC_IDX = #{francIdx}
		  AND   OPTION_PROD_IDX = #{optionProdIdx}
	</update>
	
	<insert id="OptionProd_InsertScheduleVersion" parameterType="qss.vo.OptionProdVo">
		/*
		  ID  : OptionProd_sql.OptionProd_InsertScheduleVersion
		  DEC : 옵션 상품 기준  주문조회 스케줄버전 추가
		*/
		INSERT INTO SCHEDULE_VERSION
		(
		  DEVICE_CODE
		 ,SCHEDULE_VERSION_IDX
		 ,SCHEDULE_TYPE
		 ,MOD_REASON
		 ,REG_USER
		 ,REG_DATE
		 ,MOD_USER
		 ,MOD_DATE
		)
		SELECT *
	    FROM
	    (
			SELECT K.DEVICE_CODE
			      ,(
			      		SELECT IFNULL(MAX(SCHEDULE_VERSION_IDX) + 1, 1)
			      		FROM   SCHEDULE_VERSION
			      		WHERE  DEVICE_CODE = K.DEVICE_CODE
			      	) AS SCHEDULE_VERSION_IDX
			      ,#{scheduleType} AS SCHEDULE_TYPE
			      ,(
			      		SELECT CODE_NAME
			      		FROM   SYSTEM_CODE
			      		WHERE  CODE_GROUP = 'SCH0000' AND  CODE_VALUE = #{scheduleType}
			      		AND    IFNULL(DEL_YN, 'N') = 'N'
			      	) AS MOD_REASON
			      ,#{regUser} AS REG_USER
			      ,now() AS REG_DATE
			      ,#{regUser} AS MOD_USER
			      ,now() AS MOD_DATE
			FROM   OPTION_PROD OP
			INNER  JOIN KIOSK K
	        ON     K.DOMAIN_IDX = OP.DOMAIN_IDX
			AND    K.BRAND_IDX = OP.BRAND_IDX
			AND    K.FRANC_IDX = OP.FRANC_IDX
	        AND    K.DOMAIN_IDX = #{domainIdx}
			AND    K.BRAND_IDX = #{brandIdx}
			AND    K.FRANC_IDX = #{francIdx}
			AND    IFNULL(K.DEL_YN, 'N') = 'N'

		     ) A
            GROUP BY DEVICE_CODE, SCHEDULE_TYPE, MOD_REASON, REG_USER, REG_DATE, MOD_USER, MOD_DATE
	</insert>
	
	<update id="OptionProd_ActiveOptionProd"  parameterType="qss.vo.OptionProdVo" >
		/*
		  ID  : Optionprod_sql.OptionProd_ActiveOptionProd
		  DEC : 옵션 상품 활성화
		*/
		UPDATE OPTION_PROD
		SET    ACTIVE_YN = #{activeYn}
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    FRANC_IDX = #{francIdx}
		AND    OPTION_PROD_IDX = #{optionProdIdx}
	</update>
	
	<update id="OptionProd_DeleteOptionProd"  parameterType="qss.vo.OptionProdVo" >
		/*
		  ID  : Optionprod_sql.OptionProd_DeleteOptionProd
		  DEC : 옵션 상품 삭제
		*/
		UPDATE OPTION_PROD
		SET    DEL_YN = 'Y'
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		 AND   FRANC_IDX = #{francIdx}
		AND    OPTION_PROD_IDX IN
		<foreach collection="checkboxArr" item="id" open="(" close=")" separator=",">
	        #{id}
	    </foreach>
	</update>
	
	<!-- 상품 리스트 조회 -->
	<select id="OptionProd_FormListOptionProd" parameterType="qss.vo.OptionProdVo" resultType="qss.vo.OptionProdVo">
		/*
		  ID  : OptionProd_sql.OptionProd_FormListOptionProd
		  DEC : 상품 리스트 조회
		*/
		<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
			SELECT
				  OP.DOMAIN_IDX			/*도메인일련번호*/
				,OP.BRAND_IDX				/*브랜드일련번호*/
				,OP.FRANC_IDX				/*가맹점일련번호*/
				,OP.OPTION_PROD_IDX			/*옵션 상품 일련번호*/
				,OP.OPTION_PROD_NAME				/*상품명*/
				,OP.OPTION_PROD_DISPLAY_NAME		/*상품 표시명*/
				,OP.OPTION_PROD_EN_NAME			/*상품 영문명*/
				,FORMAT(OP.OPTION_PROD_AMOUNT,0) as OPTION_PROD_AMOUNT	/*상품 가격*/
				,FORMAT(OP.OPTION_PROD_DISCOUNT_AMOUNT,0) as OPTION_PROD_DISCOUNT_AMOUNT	/*상품 할인 가격*/
				, date_format(OP.MOD_DATE, '%Y-%m-%d') AS MOD_DATE
				,OP.ACTIVE_YN
			FROM  OPTION_PROD OP
				  INNER JOIN franchisee f ON  f.DOMAIN_IDX = OP.DOMAIN_IDX AND f.BRAND_IDX = OP.BRAND_IDX AND f.FRANC_IDX = OP.FRANC_IDX AND ifnull(f.DEL_YN, 'N') = 'N'
      			  INNER JOIN brand b ON  b.DOMAIN_IDX = OP.DOMAIN_IDX AND b.BRAND_IDX = OP.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
			WHERE IFNULL(OP.DEL_YN, 'N') = 'N'
			<if test="activeYn != null and activeYn != ''">
	           AND    ifnull(OP.ACTIVE_YN, 'Y') = 'Y'
	        </if>
			AND   OP.DOMAIN_IDX = #{domainIdx}
			<!-- 루트 조회 필요 -->
			<if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
				AND OP.BRAND_IDX = #{brandIdx}
			</if>
			<if test="francIdx != null and francIdx != '' and francIdx != 0">
				AND OP.FRANC_IDX = #{francIdx}
			</if>
			<if test="sSearch != null and sSearch != ''">
	            AND OP.OPTION_PROD_DISPLAY_NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>
         </if>
         <!-- 시스템 관라지가 아닐경우(브랜드, 매장 관리자) -->
		 <if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
			SELECT
				  OP.DOMAIN_IDX			/*도메인일련번호*/
				,OP.BRAND_IDX				/*브랜드일련번호*/
				,OP.FRANC_IDX				/*가맹점일련번호*/
				,OP.OPTION_PROD_IDX			/*옵션 상품 일련번호*/
				,OP.OPTION_PROD_NAME				/*상품명*/
				,OP.OPTION_PROD_DISPLAY_NAME		/*상품 표시명*/
				,OP.OPTION_PROD_EN_NAME			/*상품 영문명*/
				,FORMAT(OP.OPTION_PROD_AMOUNT,0) as OPTION_PROD_AMOUNT	/*상품 가격*/
				,FORMAT(OP.OPTION_PROD_DISCOUNT_AMOUNT,0) as OPTION_PROD_DISCOUNT_AMOUNT	/*상품 할인 가격*/
				, date_format(OP.MOD_DATE, '%Y-%m-%d') AS MOD_DATE
				,OP.ACTIVE_YN
			FROM  OPTION_PROD OP
				  INNER JOIN franchisee f ON  f.DOMAIN_IDX = OP.DOMAIN_IDX AND f.BRAND_IDX = OP.BRAND_IDX AND f.FRANC_IDX = OP.FRANC_IDX AND ifnull(f.DEL_YN, 'N') = 'N'
      			  INNER JOIN brand b ON  b.DOMAIN_IDX = OP.DOMAIN_IDX AND b.BRAND_IDX = OP.BRAND_IDX AND ifnull(b.DEL_YN, 'N') = 'N'
			WHERE IFNULL(OP.DEL_YN, 'N') = 'N'
			AND   OP.DOMAIN_IDX = #{domainIdx}
			<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
			 	/* 브랜드 관리자는 해당 브랜드에 포함된 모든 매장 포함되게 또는 선택한 매장만 */
				AND OP.BRAND_IDX = #{sessionBrandIdx}
				<if test="francIdx != null and francIdx != '' and francIdx != 0">
				AND OP.FRANC_IDX = #{francIdx}
				</if>
			 </if>

			 <if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0003'">
			 	/* 매장 관리자는 자신이 속한 브랜드의 자기 매장만 보이게 */
			 	AND OP.BRAND_IDX = #{sessionBrandIdx}
				AND OP.FRANC_IDX = #{sessionFrancIdx}
			 </if>
			 <if test="sSearch != null and sSearch != ''">
	            AND OP.OPTION_PROD_DISPLAY_NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>

		 </if>

       
	</select>
	
	<select id="OptionProd_OverlapCountOptionProd" parameterType="qss.vo.OptionProdVo" resultType="int">
		/*
		  ID    : optionprod_sql.OptionProd_OverlapCountOptionProd
		  DEC   : 옵션 주문상품 코드 중복체크
		*/
		SELECT  count(*)
		FROM    OPTION_PROD
		WHERE   ifnull(DEL_YN, 'N') = 'N'
		AND     DOMAIN_IDX = #{domainIdx}
		AND     BRAND_IDX = #{brandIdx}
		AND     FRANC_IDX = #{francIdx}
		AND     OPTION_PROD_CODE = #{optionProdCode}
		<!-- 수정시 필요 -->
		<if test="optionProdIdx != null and optionProdIdx != '' and optionProdIdx != 0">
				 AND OPTION_PROD_IDX != #{optionProdIdx}
		</if>
	</select>


</mapper>