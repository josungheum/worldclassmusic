<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="BrandManagement">

	<select id="Brand_ViewBrand" parameterType="qss.vo.BrandVo" resultType="qss.vo.BrandVo">
	    /*
		  ID    : brand_sql.Brand_ViewBrand
		  DEC   : 브랜드 기본 속성 조회
		*/
		SELECT  DOMAIN_IDX
		      , BRAND_IDX
		      , BRAND_CODE
		      , NAME
		      , (
		      		SELECT COUNT(*)
		      		FROM   FRANCHISEE
		      		WHERE  DOMAIN_IDX = B.DOMAIN_IDX
		      		AND    BRAND_IDX = B.BRAND_IDX
		      		AND    IFNULL(DEL_YN, 'N') = 'N'
		      	) AS ORDER_SHEET_TYPE
		      , LOGO_FILE
		      , BRAND_IMG
		      , (
		      		SELECT THUMBNAIL_PATH
		      		FROM FILE_CONTENT
		      		WHERE FILE_CONTENT_IDX = B.LOGO_FILE
		      	) AS THUMBNAIL_PATH
			  , (
				SELECT THUMBNAIL_PATH
				FROM FILE_CONTENT
				WHERE FILE_CONTENT_IDX = B.BRAND_IMG
			  ) AS BRAND_THUMBNAIL_PATH
			  , (
				SELECT SAVE_PATH
				FROM FILE_CONTENT
				WHERE FILE_CONTENT_IDX = B.BRAND_IMG
			  ) AS BRAND_MAIN_IMG_PATH
          	  , date_format(REG_DATE, '%Y-%m-%d') AS REG_DATE
         	  , date_format(MOD_DATE, '%Y-%m-%d') AS MOD_DATE
         	  , ACTIVE_YN
		FROM    BRAND B
		WHERE   ifnull(DEL_YN, 'N') = 'N'
		AND     DOMAIN_IDX = #{domainIdx}
		AND     BRAND_IDX = #{brandIdx}
	</select>

	<select id="Brand_OverlapCountBrand" parameterType="qss.vo.BrandVo" resultType="int">
		/*
		  ID    : brand_sql.Brand_OverlapCountBrand
		  DEC   : 브랜드 코드 중복체크
		*/
		SELECT  count(*)
		FROM    BRAND
		WHERE   ifnull(DEL_YN, 'N') = 'N'
		AND     DOMAIN_IDX = #{domainIdx}
		AND     BRAND_CODE = #{brandCode}
		<!-- 수정시 필요 -->
		<if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
			AND     BRAND_IDX != #{brandIdx}
		</if>
	</select>

	<insert id="Brand_InsertBrand" parameterType="qss.vo.BrandVo" >
		/*
		  ID  : brand_sql.Brand_InsertBrand
		  DEC : 브랜드 기본 속성 등록
		*/
		<selectKey resultType="String" keyProperty="returnBrandIdx" order="BEFORE">
			SELECT
				IFNULL(MAX(CONVERT(BRAND_IDX, UNSIGNED)) + 1, '20000000001')
			FROM BRAND
			WHERE DOMAIN_IDX = #{domainIdx}
	    </selectKey>
		INSERT INTO BRAND
		(
			  DOMAIN_IDX
			, BRAND_IDX
			, BRAND_CODE
			, NAME
			, ORDER_SHEET_TYPE
			, LOGO_FILE
			, BRAND_IMG
			, ACTIVE_YN
			, DEL_YN
			, REG_USER
			, REG_DATE
			, MOD_USER
			, MOD_DATE
		)
		VALUES
		(
			 #{domainIdx}
		   , #{returnBrandIdx}
		   , #{brandCode}
		   , #{name}
		   , 0
		   , #{logoFile}
		   , #{brandImg}
		   , #{activeYn}
		   , 'N'
		   , #{regUser}
		   , now()
		   , #{regUser}
		   , now()
		 )
	</insert>

	<update id="Brand_UpdateBrand" parameterType="qss.vo.BrandVo" >
		/*
		  ID  : brand_sql.Brand_UpdateBrand
		  DEC : 브랜드 기본 속성 수정
		*/
		UPDATE BRAND
		set    MOD_USER = #{regUser}
		     , MOD_DATE = now()
		     , BRAND_CODE = #{brandCode}
		     , LOGO_FILE = #{logoFile}
		     , BRAND_IMG = #{brandImg}
		     , NAME = #{name}
		     , ACTIVE_YN = #{activeYn}
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
	</update>

	<delete id="Brand_DeleteBrandPaymentType" parameterType="qss.vo.BrandPaymentTypeVo">
		/*
		  ID  : brand_sql.Brand_DeleteBrandPaymentType
		  DEC : 브랜드 형태 삭제
		*/
		DELETE FROM BRAND_PAYMENT_TYPE
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    BRAND_ONLY_YN = 'Y'


	</delete>

	<insert id="Brand_InsertBrandPaymentType" parameterType="qss.vo.BrandPaymentTypeVo">
		/*
		  ID  : brand_sql.Brand_InsertBrandPaymentType
		  DEC : 브랜드 형태 저장
		*/
		<selectKey resultType="BigInteger" keyProperty="payTypeIdx" order="BEFORE">
	        SELECT IFNULL(MAX(PAY_TYPE_IDX) + 1, '1')
			FROM   BRAND_PAYMENT_TYPE
	    </selectKey>
	    INSERT INTO BRAND_PAYMENT_TYPE
		   (
			   DOMAIN_IDX
			 , BRAND_IDX
			 , PAY_TYPE_IDX
			 , PAY_TYPE_GROUP
			 , PAY_TYPE
			 , BRAND_ONLY_YN
			 , FRANC_IDX
			 , REG_USER
			 , REG_DATE
			 , MOD_USER
			 , MOD_DATE
			 
			)
			VALUES
			(
				#{domainIdx}
			  , #{brandIdx}
			  , #{payTypeIdx}
			  , #{payTypeGroup}
			  , #{payType}
			  , #{brandOnlyYn}
			  , #{francIdx}
			  , #{regUser}
			  , now()
			  , #{regUser}
			  , now()
			)
	</insert>

	<select id="Brand_ListBrandPaymentType" parameterType="qss.vo.BrandVo" resultType="qss.vo.BrandPaymentTypeVo">
	    /*
		  ID  : brand_sql.Brand_ListBrandPaymentType
		  DEC : 브랜드 기본 형태 조회
		*/
		SELECT DOMAIN_IDX
		     , BRAND_IDX
		     , PAY_TYPE_IDX
		     , PAY_TYPE
		     , BRAND_ONLY_YN
		     , FRANC_IDX
		     , PAY_TYPE_GROUP
		FROM   BRAND_PAYMENT_TYPE B
		WHERE  BRAND_ONLY_YN = 'Y'
		AND    DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}

	</select>

	<update id="Brand_DeleteBrand"  parameterType="qss.vo.BrandVo" >
		/*
		  ID  : brand_sql.Brand_DeleteBrand
		  DEC : 브랜드 삭제
		*/
		UPDATE BRAND
		SET    DEL_YN = 'Y'
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}

	</update>

	<select id="Brand_ListBrand" parameterType="qss.vo.BrandVo" resultType="qss.vo.BrandVo">
		 /*
		  ID  : brand_sql.Brand_ListBrand
		  DEC : 브랜드 리스트 조회
		*/
		   <include refid="Common.BeforeSQL"/>
		   	<!-- 시스템 관라지 일경우 -->
			<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
				SELECT DOMAIN_IDX
				     , BRAND_IDX
				     , BRAND_CODE
			         , NAME
			         , ACTIVE_YN
			         , (
			         		SELECT COUNT(*)
			         		FROM   FRANCHISEE
			         		WHERE  DOMAIN_IDX = B.DOMAIN_IDX
			         		AND    BRAND_IDX = B.BRAND_IDX
			         		AND    IFNULL(DEL_YN, 'N') = 'N'
			         	) AS ORDER_SHEET_TYPE
			         , date_format(MOD_DATE, '%Y-%m-%d') AS MOD_DATE
				FROM   BRAND B
				WHERE  IFNULL(DEL_YN, 'N') = 'N'
				AND    DOMAIN_IDX = #{domainIdx}
				<!-- 루트 조회 필요 -->
				<if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
					AND BRAND_IDX = #{brandIdx}
				</if>
				<if test="sSearch != null and sSearch != ''">
		            AND NAME LIKE CONCAT('%',#{sSearch},'%')
		         </if>
			</if>
			<!-- 시스템 관라지가 아닐경우(브랜드, 매장 관리자) -->
			<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
				SELECT DOMAIN_IDX
				     , BRAND_IDX
				     , BRAND_CODE
			         , NAME
			         , ACTIVE_YN
			         , (
			         		SELECT COUNT(*)
			         		FROM   FRANCHISEE
			         		WHERE  DOMAIN_IDX = B.DOMAIN_IDX
			         		AND    BRAND_IDX = B.BRAND_IDX
			         		AND    IFNULL(DEL_YN, 'N') = 'N'
			         	) AS ORDER_SHEET_TYPE
			         , date_format(MOD_DATE, '%Y-%m-%d') AS MOD_DATE
				FROM   BRAND B
				WHERE  IFNULL(DEL_YN, 'N') = 'N'
				AND    DOMAIN_IDX = #{domainIdx}
				<if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
				 	/* 브랜드 관리자는 해당 브랜드에 포함된 모든 매장 포함되게 또는 선택한 매장만 */
					AND BRAND_IDX = #{sessionBrandIdx}
				 </if>
				<if test="sSearch != null and sSearch != ''">
		            AND NAME LIKE CONCAT('%',#{sSearch},'%')
		         </if>
			</if>
			<if test="sSortName == null or sSortName == ''">
<!-- 			ORDER BY MOD_DATE -->
			</if>
			<include refid="Common.AfterSQL"/>

	</select>

	<select id="Brand_ListCountBrand" parameterType="qss.vo.BrandVo" resultType="int">
		/*
		  ID  : Brand_sql.Brand_ListCountBrand
		  DEC : 브랜드 리스트 카운터
		*/
		<!-- 시스템 관라지 일경우 -->
		<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType == 'ADM0001'">
			SELECT COUNT(*)
			 FROM   BRAND
			 WHERE  IFNULL(DEL_YN, 'N') = 'N'
			 AND    DOMAIN_IDX = #{domainIdx}
			 <!-- 루트 조회 필요 -->
			 <if test="brandIdx != null and brandIdx != '' and brandIdx != 0">
				AND BRAND_IDX = #{brandIdx}
			 </if>
			 <if test="sSearch != null and sSearch != ''">
	            AND NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>
		</if>

		<!-- 시스템 관라지가 아닐경우(브랜드, 매장 관리자) -->
		<if test="sessionAdminType != null and sessionAdminType != '' and sessionAdminType != 'ADM0001'">
			SELECT COUNT(*)
			 FROM   BRAND
			 WHERE  IFNULL(DEL_YN, 'N') = 'N'
			 AND    DOMAIN_IDX = #{domainIdx}
			 <!-- 루트 조회 필요 -->
			 <if test="sessionBrandIdx != null and sessionAdminType != '' and sessionAdminType == 'ADM0002'">
			 	/* 브랜드 관리자는 해당 브랜드에 포함된 모든 매장 포함되게 또는 선택한 매장만 */
				AND BRAND_IDX = #{sessionBrandIdx}
			 </if>
			 <if test="sSearch != null and sSearch != ''">
	            AND NAME LIKE CONCAT('%',#{sSearch},'%')
	         </if>
		</if>
	</select>

	<update id="Brand_ActiveBrand" parameterType="qss.vo.BrandVo">
		/*
		  ID  : brand_sql.Brand_ActiveBrand
		  DEC : 브랜드 활성화 여부
		*/
		UPDATE BRAND
		set    MOD_USER = #{regUser}
		     , MOD_DATE = now()
		     , ACTIVE_YN = #{activeYn}
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}

	</update>

	<select id="Brand_ListDiscount" parameterType="qss.vo.BrandVo" resultType="qss.vo.BrandVo">
	   /*
		  ID  : brand_sql.Brand_ListDiscount
		  DEC : 브랜드 할인율 리스트 조회
		*/
		<include refid="Common.BeforeSQL"/>
		SELECT  DISCOUNT_IDX
		      , DISCOUNT_NAME
		      , (
		      		SELECT CODE_NAME
		      		FROM   SYSTEM_CODE
		      		WHERE  CODE_VALUE = D.DISCOUNT_LEVEL
		      		AND    IFNULL(DEL_YN, 'N') = 'N'
		      	) AS DISCOUNT_LEVEL
		      , DISCOUNT_PERCENT
		      , date_format(START_DATE, '%Y-%m-%d') AS START_DATE
		      , date_format(END_DATE, '%Y-%m-%d') AS END_DATE
		      , ACTIVE_YN
		FROM    DISCOUNT D
		WHERE   IFNULL(DEL_YN, 'N') = 'N'
		AND     DOMAIN_IDX = #{domainIdx}
		AND     BRAND_IDX = #{brandIdx}
		<if test="sSearch != null and sSearch != ''">
            AND DISCOUNT_NAME LIKE CONCAT('%',#{sSearch},'%')
         </if>
         <if test="sSortName == null or sSortName == ''">
<!--          ORDER BY END_DATE -->
         </if>
         <include refid="Common.AfterSQL"/>

	</select>

	<select id="Brand_ListCountDiscount" parameterType="qss.vo.BrandVo" resultType="int">
		/*
		  ID  : Brand_sql.Brand_ListCountDiscount
		  DEC : 브랜드 할인율 리스트 조회
		*/
		 SELECT COUNT(*)
		 FROM   DISCOUNT
		 WHERE  IFNULL(DEL_YN, 'N') = 'N'
		 AND    DOMAIN_IDX = #{domainIdx}
		 AND    BRAND_IDX = #{brandIdx}
		 <if test="sSearch != null and sSearch != ''">
            AND DISCOUNT_NAME LIKE CONCAT('%',#{sSearch},'%')
         </if>
	</select>

	<insert id="Brand_InsertDiscount" parameterType="qss.vo.BrandVo">
		/*
		  ID  : brand_sql.Brand_InsertDiscount
		  DEC : 브랜드 할인율 등록
		*/
		<selectKey resultType="BigInteger" keyProperty="discountIdx" order="BEFORE">
	        SELECT IFNULL(MAX(DISCOUNT_IDX) + 1, '1')
			FROM   DISCOUNT
			WHERE  DOMAIN_IDX = #{domainIdx}
			AND    BRAND_IDX = #{brandIdx}
	    </selectKey>
		INSERT INTO DISCOUNT
		(
			  DOMAIN_IDX
			, BRAND_IDX
			, DISCOUNT_IDX
			, DISCOUNT_NAME
			, DISCOUNT_LEVEL
			, DISCOUNT_PERCENT
			, START_DATE
			, END_DATE
			, ACTIVE_YN
			, DEL_YN
			, REG_USER
			, REG_DATE
			, MOD_USER
			, MOD_DATE
		)
		VALUES
		(
			 #{domainIdx}
		   , #{brandIdx}
		   , #{discountIdx}
		   , #{discountName}
		   , #{discountLevel}
		   , #{discountPercent}
		   , #{startDate}
		   , #{endDate}
		   , #{activeYn}
		   , 'N'
		   , #{regUser}
		   , now()
		   , #{regUser}
		   , now()
		 )
	</insert>

	<update id="Brand_ActiveDiscount" parameterType="qss.vo.BrandVo">
		/*
		  ID  : brand_sql.Brand_ActiveDiscount
		  DEC : 브랜드 할인율 활성화 여부
		*/
		UPDATE DISCOUNT
		set    MOD_USER = #{regUser}
		     , MOD_DATE = now()
		     , ACTIVE_YN = #{activeYn}
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    DISCOUNT_IDX = #{discountIdx}

	</update>


	<select id="Brand_ViewDiscount" parameterType="qss.vo.BrandVo" resultType="qss.vo.BrandVo">
		/*
		  ID  : brand_sql.Brand_ViewDiscount
		  DEC : 브랜드 할인율 상세 조회
		*/
		SELECT  DISCOUNT_IDX
		      , DISCOUNT_NAME
		      , DISCOUNT_LEVEL
		      , DISCOUNT_PERCENT
		      , date_format(START_DATE, '%Y-%m-%d') AS START_DATE
		      , date_format(END_DATE, '%Y-%m-%d') AS END_DATE
		      , ACTIVE_YN
		FROM    DISCOUNT
		WHERE   IFNULL(DEL_YN, 'N') = 'N'
		AND     DOMAIN_IDX = #{domainIdx}
		AND     BRAND_IDX = #{brandIdx}
		AND     DISCOUNT_IDX = #{discountIdx}
	</select>



	<update id="Brand_UpdateDiscount" parameterType="qss.vo.BrandVo" >
		/*
		  ID  : brand_sql.Brand_UpdateDiscount
		  DEC : 브랜드 할인율 수정
		*/
		UPDATE DISCOUNT
		SET	   DISCOUNT_NAME = #{discountName}
			 , DISCOUNT_LEVEL = #{discountLevel}
			 , DISCOUNT_PERCENT = #{discountPercent}
			 , START_DATE = #{startDate}
			 , END_DATE = #{endDate}
			 , ACTIVE_YN = #{activeYn}
			 , MOD_DATE = now()
			 , MOD_USER = #{regUser}
	     WHERE DOMAIN_IDX = #{domainIdx}
	     AND   BRAND_IDX = #{brandIdx}
	     AND   DISCOUNT_IDX = #{discountIdx}

	</update>

	<update id="Brand_DeleteDiscount"  parameterType="qss.vo.BrandVo" >
		/*
		  ID  : brand_sql.Brand_DeleteDiscount
		  DEC : 브랜드 할인율 삭제
		*/
		UPDATE DISCOUNT
		SET    DEL_YN = 'Y'
		     , MOD_USER = #{regUser}
		     , MOD_DATE = now()
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    DISCOUNT_IDX IN
		<foreach collection="checkboxArr" item="discountIdx" open="(" close=")" separator=",">
	        #{discountIdx}
	    </foreach>
	</update>

	<insert id="Brand_InsertScheduleVersion" parameterType="qss.vo.BrandVo">
	    /*
		  ID  : brand_sql.Brand_InsertScheduleVersion
		  DEC : 브랜드 스케줄 저장
		*/
		INSERT INTO SCHEDULE_VERSION
		(
		  DEVICE_CODE
		 ,SCHEDULE_VERSION_IDX
		 ,SCHEDULE_TYPE
		 ,MOD_REASON
		 ,REG_USER
		 ,REG_DATE
		 ,MOD_USER
		 ,MOD_DATE
		)
		SELECT DEVICE_CODE
		      ,(
		      		SELECT IFNULL(MAX(SCHEDULE_VERSION_IDX) + 1, 1)
		      		FROM   SCHEDULE_VERSION
		      		WHERE  DEVICE_CODE = K.DEVICE_CODE
<!-- 		      		AND    SCHEDULE_TYPE = #{scheduleType} -->
		      	) AS SCHEDULE_VERSION_IDX
		      ,#{scheduleType} AS SCHEDULE_TYPE
		      ,(
		      		SELECT CODE_NAME
		      		FROM   SYSTEM_CODE
		      		WHERE  CODE_VALUE = #{scheduleType}
		      		AND    IFNULL(DEL_YN, 'N') = 'N'
		      	) AS MOD_REASON
		      ,#{regUser} AS REG_USER
		      ,now() AS REG_DATE
		      ,#{regUser} AS MOD_USER
		      ,now() AS MOD_DATE
		FROM   KIOSK K
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
		AND    IFNULL(K.DEL_YN, 'N') = 'N'

	</insert>



	<delete id="Brand_DeleteBrandDeviceType" parameterType="qss.vo.BrandDeviceTypeVo">
		/*
		  ID  : brand_sql.Brand_DeleteBrandDeviceType
		  DEC : 브랜드 별 디바이스 종류  삭제
		*/
		DELETE FROM BRAND_DEVICE_TYPE
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}
	</delete>

	<insert id="Brand_InsertBrandDeviceType" parameterType="qss.vo.BrandDeviceTypeVo">
		/*
		  ID  : brand_sql.Brand_InsertBrandDeviceType
		  DEC : 브랜드 별 디바이스 종류 저장
		*/
		<selectKey resultType="BigInteger" keyProperty="deviceTypeIdx" order="BEFORE">
	        SELECT IFNULL(MAX(DEVICE_TYPE_IDX) + 1, '1')
			FROM   BRAND_DEVICE_TYPE
	    </selectKey>
	    INSERT INTO BRAND_DEVICE_TYPE
		   (
			   DOMAIN_IDX
			 , BRAND_IDX
			 , DEVICE_TYPE_IDX
		     , DEVICE_TYPE
			 , REG_USER
			 , REG_DATE
			 , MOD_USER
			 , MOD_DATE
			)
			VALUES
			(
				#{domainIdx}
			  , #{brandIdx}
			  , #{deviceTypeIdx}
			  , #{deviceType}
			  , #{regUser}
			  , now()
			  , #{regUser}
			  , now()
			)
	</insert>

	<select id="Brand_ListBrandDeviceType" parameterType="qss.vo.BrandVo" resultType="qss.vo.BrandDeviceTypeVo">
	    /*
		  ID  : brand_sql.Brand_ListBrandDeviceType
		  DEC : 브랜드 별 디바이스 종류  조회
		*/
		SELECT DOMAIN_IDX
		     , BRAND_IDX
		     , DEVICE_TYPE_IDX
		     , DEVICE_TYPE
		     , (SELECT CODE_NAME FROM  SYSTEM_CODE WHERE  CODE_GROUP = 'DVC0000' AND  CODE_VALUE = K.DEVICE_TYPE AND IFNULL(DEL_YN, 'N') = 'N' ) AS DEVICE_TYPE_NAME
		FROM   BRAND_DEVICE_TYPE K
		WHERE  DOMAIN_IDX = #{domainIdx}
		AND    BRAND_IDX = #{brandIdx}

	</select>
</mapper>